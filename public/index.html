<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>黑心公司大亨 v2.3 - 复杂生产链+借贷系统</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d3436 50%, #636e72 100%);
            color: #ddd;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* 新闻滚动条样式 */
        .news-ticker {
            background: linear-gradient(90deg, #e17055, #d63031);
            color: white;
            padding: 8px 0;
            white-space: nowrap;
            overflow: hidden;
            border-bottom: 2px solid #fdcb6e;
            font-size: 14px;
            font-weight: bold;
        }
        
        .news-content {
            display: inline-block;
            animation: scroll-left 60s linear infinite;
            padding-left: 100%;
        }
        
        @keyframes scroll-left {
            0% { transform: translate3d(100%, 0, 0); }
            100% { transform: translate3d(-100%, 0, 0); }
        }
        
        /* 版本更新提示 */
        .version-banner {
            background: linear-gradient(135deg, #00b894, #00a085);
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: bold;
            border-bottom: 2px solid #fdcb6e;
        }
        
        /* 破产警告 */
        .bankruptcy-warning {
            background: linear-gradient(135deg, #d63031, #e17055);
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: bold;
            border-bottom: 2px solid #fdcb6e;
            animation: pulse 1s infinite;
        }
        
        /* 电力不足警告 */
        .power-shortage {
            background: linear-gradient(135deg, #fdcb6e, #f39c12);
            color: #2d3436;
            padding: 10px;
            text-align: center;
            font-weight: bold;
            margin: 10px 0;
            border-radius: 8px;
        }
        
        /* 股价K线图容器 */
        .stock-chart-container {
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        
        .stock-chart-header {
            color: #fdcb6e;
            margin-bottom: 15px;
            font-size: 20px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .stock-chart {
            position: relative;
            height: 200px;
            margin-bottom: 15px;
        }
        
        /* 登录界面 */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        
        .login-form {
            background: linear-gradient(135deg, #2d3436, #636e72);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.8);
            border: 3px solid #fdcb6e;
            text-align: center;
            color: #ddd;
            max-width: 500px;
            width: 90%;
        }
        
        .login-title {
            font-size: 32px;
            margin-bottom: 10px;
            color: #fdcb6e;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }
        
        .version-tag {
            font-size: 16px;
            color: #00b894;
            margin-bottom: 20px;
            font-weight: bold;
        }
        
        .login-subtitle {
            font-size: 16px;
            margin-bottom: 30px;
            color: #ddd;
            font-style: italic;
        }
        
        .login-input {
            width: 100%;
            padding: 15px;
            margin: 15px 0;
            border: none;
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            color: #ddd;
            font-size: 16px;
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }
        
        .login-input:focus {
            border-color: #fdcb6e;
            outline: none;
            background: rgba(255,255,255,0.15);
        }
        
        .company-type-selector {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 20px 0;
        }
        
        .company-type {
            padding: 15px;
            border: 2px solid rgba(253,203,110,0.3);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(0,0,0,0.3);
        }
        
        .company-type:hover {
            border-color: #fdcb6e;
            background: rgba(253,203,110,0.1);
        }
        
        .company-type.selected {
            border-color: #fdcb6e;
            background: rgba(253,203,110,0.2);
        }
        
        .company-type-title {
            font-weight: bold;
            color: #fdcb6e;
            margin-bottom: 5px;
        }
        
        .company-type-desc {
            font-size: 12px;
            color: #bbb;
        }
        
        .login-btn {
            width: 100%;
            padding: 15px;
            margin: 20px 0;
            border: none;
            border-radius: 8px;
            background: linear-gradient(135deg, #e17055, #d63031);
            color: white;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        
        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(225,112,85,0.4);
        }
        
        .feature-list {
            margin-top: 25px;
            font-size: 14px;
            color: #bbb;
            line-height: 1.8;
            text-align: left;
        }
        
        .feature-item {
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .feature-icon {
            width: 20px;
            font-size: 16px;
        }
        
        /* 游戏主界面 */
        .game-container {
            display: none;
            min-height: 100vh;
        }
        
        .header {
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-bottom: 2px solid rgba(253,203,110,0.3);
        }
        
        .company-title {
            text-align: center;
            font-size: 28px;
            margin-bottom: 15px;
            background: linear-gradient(45deg, #fdcb6e, #e17055);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: none;
        }
        
        .company-info {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 20px;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(0,0,0,0.5);
            border-radius: 10px;
        }
        
        .company-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
        }
        
        .stat-item {
            text-align: center;
            padding: 8px;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            border: 1px solid rgba(253,203,110,0.2);
        }
        
        .stat-label {
            font-size: 11px;
            color: #bbb;
            margin-bottom: 3px;
        }
        
        .stat-value {
            font-size: 16px;
            font-weight: bold;
            color: #fdcb6e;
        }
        
        /* 资金状态 */
        .finance-status {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .finance-item {
            background: linear-gradient(135deg, #2d3436, #636e72);
            color: white;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            font-size: 12px;
            font-weight: bold;
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.3s ease;
        }
        
        .finance-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .finance-item.money { background: linear-gradient(135deg, #fdcb6e, #e17055); }
        .finance-item.debt { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        .finance-item.power { background: linear-gradient(135deg, #f39c12, #e67e22); }
        .finance-item.leverage { background: linear-gradient(135deg, #9b59b6, #8e44ad); }
        
        .global-event-banner {
            background: linear-gradient(135deg, #e17055, #d63031);
            color: white;
            padding: 15px;
            text-align: center;
            margin-bottom: 20px;
            border-radius: 10px;
            border: 2px solid #fdcb6e;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        .main-layout {
            display: grid;
            grid-template-columns: 2fr 1fr;
            min-height: calc(100vh - 200px);
        }
        
        .left-content {
            padding: 20px;
        }
        
        .chart-section {
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        
        .chart-header {
            color: #fdcb6e;
            margin-bottom: 15px;
            font-size: 20px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .chart-container {
            position: relative;
            height: 250px;
            margin-bottom: 15px;
        }
        
        .right-panel {
            background: rgba(0,0,0,0.8);
            border-left: 2px solid rgba(253,203,110,0.3);
            display: flex;
            flex-direction: column;
        }
        
        .chat-section {
            flex: 1;
            padding: 20px;
            border-bottom: 2px solid rgba(253,203,110,0.3);
            min-height: 300px;
        }
        
        .chat-header {
            color: #fdcb6e;
            margin-bottom: 15px;
            font-size: 18px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .chat-messages {
            height: 200px;
            overflow-y: auto;
            margin-bottom: 15px;
            padding: 15px;
            background: rgba(0,0,0,0.5);
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .chat-message {
            margin-bottom: 10px;
            font-size: 13px;
            line-height: 1.4;
            padding: 8px;
            background: rgba(0,0,0,0.3);
            border-radius: 6px;
        }
        
        .chat-time {
            color: #888;
            font-size: 10px;
        }
        
        .chat-player {
            color: #fdcb6e;
            font-weight: bold;
            margin: 0 5px;
        }
        
        .chat-text {
            color: #ddd;
        }
        
        .chat-input-container {
            display: flex;
            gap: 10px;
        }
        
        .chat-input {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            color: #ddd;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .chat-input:focus {
            outline: none;
            border-color: #fdcb6e;
            background: rgba(255,255,255,0.15);
        }
        
        .chat-send {
            padding: 12px 18px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(135deg, #e17055, #d63031);
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .chat-send:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(225,112,85,0.4);
        }
        
        .leaderboard {
            padding: 20px;
            flex: 1;
        }
        
        .leaderboard-header {
            color: #fdcb6e;
            margin-bottom: 15px;
            font-size: 18px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .company-rank {
            display: flex;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            background: linear-gradient(135deg, rgba(45,52,54,0.6), rgba(99,110,114,0.6));
            border-radius: 8px;
            border-left: 3px solid transparent;
            transition: all 0.3s ease;
        }
        
        .company-rank:hover {
            transform: translateX(3px);
        }
        
        .company-rank.player {
            border-left-color: #fdcb6e;
            background: linear-gradient(135deg, rgba(253,203,110,0.15), rgba(225,112,85,0.15));
        }
        
        .company-rank.ai {
            border-left-color: #74b9ff;
        }
        
        .company-rank.bankrupt {
            opacity: 0.5;
            border-left-color: #e74c3c;
        }
        
        .rank-number {
            font-size: 16px;
            font-weight: bold;
            color: #fdcb6e;
            margin-right: 12px;
            min-width: 25px;
        }
        
        .rank-info {
            flex: 1;
        }
        
        .rank-name {
            font-weight: bold;
            color: #ddd;
            margin-bottom: 3px;
            font-size: 13px;
        }
        
        .rank-value {
            font-size: 11px;
            color: #bbb;
        }
        
        .tabs-container {
            background: rgba(0,0,0,0.7);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        
        .tabs-header {
            display: flex;
            background: rgba(0,0,0,0.5);
            overflow-x: auto;
        }
        
        .tab-button {
            flex: 1;
            padding: 15px;
            border: none;
            background: transparent;
            color: #bbb;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            font-weight: bold;
            white-space: nowrap;
            min-width: 120px;
        }
        
        .tab-button:hover {
            color: #fdcb6e;
            background: rgba(253,203,110,0.1);
        }
        
        .tab-button.active {
            color: #fdcb6e;
            border-bottom-color: #fdcb6e;
            background: rgba(253,203,110,0.1);
        }
        
        .tab-content {
            padding: 20px;
            display: none;
            min-height: 400px;
            max-height: 600px;
            overflow-y: auto;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* 工厂、市场、产品项目样式 */
        .factory-item, .market-section, .product-item, .tech-item, .production-item, .stock-item, .loan-item {
            background: linear-gradient(135deg, rgba(45,52,54,0.8), rgba(99,110,114,0.8));
            padding: 15px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            margin-bottom: 12px;
        }
        
        .factory-item:hover, .product-item:hover, .tech-item:hover, .stock-item:hover, .loan-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(253,203,110,0.2);
            border-color: rgba(253,203,110,0.5);
        }
        
        .factory-item.insufficient, .product-item.insufficient, .tech-item.insufficient {
            opacity: 0.6;
            border-color: rgba(214,48,49,0.5);
        }
        
        .factory-item.power-shortage {
            border-color: rgba(241,196,15,0.8);
            background: linear-gradient(135deg, rgba(241,196,15,0.1), rgba(230,126,34,0.1));
        }
        
        .factory-header, .product-header, .tech-header, .production-header, .stock-header, .loan-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .factory-name, .product-name, .tech-name, .production-name, .stock-name, .loan-name {
            font-weight: bold;
            color: #fdcb6e;
            font-size: 16px;
        }
        
        .factory-count, .product-price, .stock-price, .loan-amount {
            background: linear-gradient(135deg, #e17055, #d63031);
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }
        
        /* 批量操作控制面板 */
        .batch-controls {
            background: rgba(0,0,0,0.6);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 2px solid #fdcb6e;
        }
        
        .batch-header {
            color: #fdcb6e;
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 18px;
        }
        
        .batch-controls-grid {
            display: grid;
            grid-template-columns: 1fr auto auto;
            gap: 10px;
            align-items: center;
        }
        
        .batch-selector {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .batch-quantity {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
            background: #2d3436;
            color: #ddd;
            width: 80px;
        }
        
        /* 借贷面板 */
        .loan-panel {
            background: rgba(0,0,0,0.6);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 2px solid #9b59b6;
        }
        
        .loan-controls {
            display: grid;
            grid-template-columns: 1fr auto auto;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .leverage-selector {
            display: flex;
            gap: 5px;
        }
        
        .leverage-btn {
            padding: 6px 10px;
            border: 1px solid #9b59b6;
            background: transparent;
            color: #9b59b6;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.3s ease;
        }
        
        .leverage-btn.active {
            background: #9b59b6;
            color: white;
        }
        
        .leverage-btn:hover {
            background: rgba(155,89,182,0.2);
        }
        
        /* 生产进度条 */
        .production-progress {
            background: rgba(0,0,0,0.3);
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin: 8px 0;
        }
        
        .production-progress-bar {
            background: linear-gradient(90deg, #00b894, #00a085);
            height: 100%;
            transition: width 0.3s ease;
        }
        
        .production-progress-bar.paused {
            background: linear-gradient(90deg, #fdcb6e, #e17055);
        }
        
        .production-status {
            font-size: 12px;
            color: #00b894;
            margin: 5px 0;
        }
        
        .production-status.paused {
            color: #fdcb6e;
        }
        
        .production-queue {
            font-size: 11px;
            color: #bbb;
            margin-top: 5px;
        }
        
        /* 依赖关系显示 */
        .dependency-chain {
            background: rgba(0,0,0,0.3);
            padding: 10px;
            border-radius: 8px;
            margin: 8px 0;
            border-left: 3px solid #74b9ff;
        }
        
        .dependency-item {
            font-size: 11px;
            color: #74b9ff;
            margin: 2px 0;
        }
        
        .dependency-arrow {
            color: #bbb;
            margin: 0 5px;
        }
        
        /* 市场网格 */
        .market-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }
        
        .market-tier {
            background: rgba(0,0,0,0.6);
            border-radius: 10px;
            padding: 15px;
            border: 2px solid rgba(253,203,110,0.3);
        }
        
        .market-tier-header {
            font-weight: bold;
            color: #fdcb6e;
            margin-bottom: 10px;
            font-size: 18px;
        }
        
        .product-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .multiplier-selector {
            display: flex;
            gap: 5px;
            margin: 8px 0;
            justify-content: center;
        }
        
        .multiplier-btn {
            padding: 4px 8px;
            border: 1px solid #fdcb6e;
            background: transparent;
            color: #fdcb6e;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.3s ease;
        }
        
        .multiplier-btn.active {
            background: #fdcb6e;
            color: #2d3436;
        }
        
        .multiplier-btn:hover {
            background: rgba(253,203,110,0.2);
        }
        
        /* 股票交易样式 */
        .stock-controls {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
            margin-top: 8px;
        }
        
        .stock-btn {
            padding: 6px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 10px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .stock-btn.buy {
            background: linear-gradient(135deg, #00b894, #00a085);
            color: white;
        }
        
        .stock-btn.sell {
            background: linear-gradient(135deg, #e17055, #d63031);
            color: white;
        }
        
        .stock-btn.short {
            background: linear-gradient(135deg, #fd79a8, #e84393);
            color: white;
        }
        
        /* 产品等级标识 */
        .tier-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: bold;
            margin-left: 5px;
        }
        
        .tier-badge.BASIC { background: #95a5a6; color: white; }
        .tier-badge.T1 { background: #74b9ff; color: white; }
        .tier-badge.T2 { background: #a29bfe; color: white; }
        .tier-badge.T3 { background: #fd79a8; color: white; }
        .tier-badge.T4 { background: #00b894; color: white; }
        
        .btn {
            background: linear-gradient(135deg, #e17055, #d63031);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            transition: all 0.3s ease;
            margin-top: 8px;
        }
        
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(225,112,85,0.4);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn.buy {
            background: linear-gradient(135deg, #00b894, #00a085);
        }
        
        .btn.sell {
            background: linear-gradient(135deg, #e17055, #d63031);
        }
        
        .btn.build {
            background: linear-gradient(135deg, #fdcb6e, #e17055);
            color: #2d3436;
        }
        
        .btn.loan {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
        }
        
        .btn.batch {
            background: linear-gradient(135deg, #3498db, #2980b9);
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.9);
            color: #fdcb6e;
            padding: 15px 25px;
            border-radius: 10px;
            border: 2px solid #fdcb6e;
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
            max-width: 350px;
        }
        
        .notification.error {
            border-color: #e74c3c;
            color: #e74c3c;
        }
        
        .notification.success {
            border-color: #00b894;
            color: #00b894;
        }
        
        .notification.warning {
            border-color: #f39c12;
            color: #f39c12;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes bounceIn {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.3);
            }
            50% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.05);
            }
            70% {
                transform: translate(-50%, -50%) scale(0.9);
            }
            100% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }
        
        /* 滚动条样式 */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.3);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(253,203,110,0.5);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(253,203,110,0.7);
        }
        
        @media (max-width: 1200px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
            
            .right-panel {
                border-left: none;
                border-top: 2px solid rgba(253,203,110,0.3);
            }
        }
        
        @media (max-width: 768px) {
            .finance-status {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .company-info {
                grid-template-columns: 1fr;
                text-align: center;
            }
            
            .company-type-selector {
                grid-template-columns: 1fr;
            }
            
            .tabs-header {
                justify-content: flex-start;
            }
            
            .market-grid {
                grid-template-columns: 1fr;
            }
            
            .batch-controls-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- 版本更新横幅 -->
    <div class="version-banner">
        🎉 欢迎来到黑心公司大亨 v2.3！复杂生产链系统 + 借贷杠杆 + 破产机制！🎉
    </div>

    <!-- 新闻滚动条 -->
    <div class="news-ticker" id="newsTicker">
        <div class="news-content" id="newsContent">
            📰 v2.3震撼发布：复杂生产依赖链 | ⚡ 电力供应系统 | 💰 借贷杠杆交易 | 📉 破产重开机制 | 🔄 批量工厂操作...
        </div>
    </div>

    <!-- 登录界面 -->
    <div class="login-screen" id="loginScreen">
        <div class="login-form">
            <div class="login-title">🏢 黑心公司大亨 🏢</div>
            <div class="version-tag">v2.3 复杂生产链系统</div>
            <div class="login-subtitle">"从电力到奢侈品的完整产业生态"</div>
            
            <input type="text" class="login-input" id="companyName" placeholder="输入你的产业帝国名称" maxlength="25">
            
            <div style="color: #fdcb6e; font-weight: bold; margin: 20px 0 10px 0;">选择你的专业方向：</div>
            <div class="company-type-selector">
                <div class="company-type" data-type="tech">
                    <div class="company-type-title">💻 科技制造</div>
                    <div class="company-type-desc">专精电子芯片制造</div>
                </div>
                <div class="company-type" data-type="manufacturing">
                    <div class="company-type-title">🏭 重工业</div>
                    <div class="company-type-desc">钢铁机械重工制造</div>
                </div>
                <div class="company-type" data-type="energy">
                    <div class="company-type-title">⚡ 能源电力</div>
                    <div class="company-type-desc">电力供应基础设施</div>
                </div>
                <div class="company-type" data-type="finance">
                    <div class="company-type-title">💰 金融投资</div>
                    <div class="company-type-desc">杠杆交易投资专家</div>
                </div>
            </div>
            
            <button class="login-btn" onclick="joinGame()">开始产业之旅</button>
            
            <div class="feature-list">
                <div style="color: #fdcb6e; font-weight: bold; margin-bottom: 10px;">🆕 v2.3 革命性特性：</div>
                <div class="feature-item">
                    <span class="feature-icon">⚡</span>
                    <span>电力依赖：所有工厂需要电力才能运转</span>
                </div>
                <div class="feature-item">
                    <span class="feature-icon">🔗</span>
                    <span>复杂生产链：苹果→果汁→可乐→餐厅等依赖关系</span>
                </div>
                <div class="feature-item">
                    <span class="feature-icon">💰</span>
                    <span>借贷杠杆：最高10倍杠杆，以小博大</span>
                </div>
                <div class="feature-item">
                    <span class="feature-icon">📉</span>
                    <span>破产机制：资不抵债将破产重开</span>
                </div>
                <div class="feature-item">
                    <span class="feature-icon">🔄</span>
                    <span>批量操作：一键批量建造和生产</span>
                </div>
                <div class="feature-item">
                    <span class="feature-icon">📦</span>
                    <span>仓库系统：专页查看所有材料库存</span>
                </div>
            </div>
        </div>
    </div>

    <!-- 游戏主界面 -->
    <div class="game-container" id="gameContainer">
        <!-- 破产警告 -->
        <div class="bankruptcy-warning" id="bankruptcyWarning" style="display: none;">
            💀 公司已破产！所有资产将被清算，请重新开始游戏 💀
        </div>
        
        <!-- 电力不足警告 -->
        <div class="power-shortage" id="powerShortage" style="display: none;">
            ⚠️ 电力不足！生产已暂停，请建造更多发电厂 ⚠️
        </div>
        
        <div class="header">
            <div class="company-title">🏭 复杂产业生态：电力驱动的制造帝国 ⚡</div>
            
            <!-- 全球事件横幅 -->
            <div class="global-event-banner" id="globalEventBanner" style="display: none;">
                <div id="globalEventText"></div>
            </div>
            
            <div class="company-info">
                <div>
                    <div style="color: #fdcb6e; font-size: 20px; font-weight: bold; margin-bottom: 5px;">
                        <span id="currentCompany">未知公司</span>
                        <span id="companyType" style="font-size: 14px; color: #bbb; margin-left: 10px;">(制造业)</span>
                        <span style="background: #00b894; color: white; padding: 4px 8px; border-radius: 10px; font-size: 12px; margin-left: 10px;">
                            Lv.<span id="companyLevel">0</span>
                        </span>
                    </div>
                    <div style="color: #bbb; font-size: 14px;">
                        CEO: <span id="playerName">匿名</span>
                        <span id="connectionStatus" style="margin-left: 15px; color: #00b894;">● 在线</span>
                    </div>
                </div>
                
                <div class="company-stats">
                    <div class="stat-item">
                        <div class="stat-label">全球排名</div>
                        <div class="stat-value" id="globalRank">#-</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">在线CEO</div>
                        <div class="stat-value" id="onlineCount">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">公司价值</div>
                        <div class="stat-value" id="companyValue">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">股票收益</div>
                        <div class="stat-value" id="stockReturn">+0%</div>
                    </div>
                </div>
            </div>
            
            <!-- 简化的财务状态显示 -->
            <div class="finance-status" id="financeStatus">
                <!-- 只显示资金相关信息，其他移到仓库页面 -->
            </div>
        </div>
        
        <!-- 股价K线图 -->
        <div class="stock-chart-container">
            <div class="stock-chart-header">
                📈 全球公司股价走势 - 跌宕起伏
                <span style="font-size: 12px; color: #bbb;">更加真实的市场波动</span>
            </div>
            <div class="stock-chart">
                <canvas id="globalStockChart"></canvas>
            </div>
        </div>
        
        <div class="main-layout">
            <div class="left-content">
                <div class="tabs-container">
                    <div class="tabs-header">
                        <button class="tab-button active" onclick="switchTab('factories')">🏭 工厂建造</button>
                        <button class="tab-button" onclick="switchTab('production')">⚙️ 生产管理</button>
                        <button class="tab-button" onclick="switchTab('warehouse')">📦 仓库管理</button>
                        <button class="tab-button" onclick="switchTab('markets')">🏪 市场交易</button>
                        <button class="tab-button" onclick="switchTab('finance')">💰 金融投资</button>
                        <button class="tab-button" onclick="switchTab('research')">🔬 科技研发</button>
                    </div>
                    
                    <div class="tab-content active" id="factories-tab">
                        <!-- 工厂产能图表 -->
                        <div class="chart-section">
                            <div class="chart-header">📊 工厂产能分析</div>
                            <div class="chart-container">
                                <canvas id="factoryChart"></canvas>
                            </div>
                        </div>
                        
                        <!-- 批量建造控制 -->
                        <div class="batch-controls">
                            <div class="batch-header">🔄 批量建造工厂</div>
                            <div class="batch-controls-grid">
                                <div class="batch-selector">
                                    <select id="batchFactoryType" style="padding: 8px; border-radius: 4px; border: 1px solid #ccc; background: #2d3436; color: #ddd;">
                                        <option value="">选择工厂类型</option>
                                    </select>
                                    <input type="number" id="batchQuantity" class="batch-quantity" placeholder="数量" min="1" value="1">
                                </div>
                                <button class="btn batch" onclick="game.batchBuildFactory()">批量建造</button>
                                <button class="btn" onclick="game.showDependencyChain()">查看生产链</button>
                            </div>
                        </div>
                        
                        <div id="factories"></div>
                    </div>
                    
                    <div class="tab-content" id="production-tab">
                        <!-- 生产进度图表 -->
                        <div class="chart-section">
                            <div class="chart-header">⚙️ 实时生产监控</div>
                            <div class="chart-container">
                                <canvas id="productionChart"></canvas>
                            </div>
                        </div>
                        
                        <!-- 批量生产控制 -->
                        <div class="batch-controls">
                            <div class="batch-header">🔄 批量生产操作</div>
                            <div class="batch-controls-grid">
                                <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 10px;">
                                    <select id="batchProductType" style="padding: 8px; border-radius: 4px; border: 1px solid #ccc; background: #2d3436; color: #ddd;">
                                        <option value="">选择产品</option>
                                    </select>
                                    <input type="number" id="batchProductQuantity" class="batch-quantity" placeholder="数量" min="1" value="1">
                                    <button class="btn batch" onclick="game.batchProduction()">批量生产</button>
                                </div>
                            </div>
                        </div>
                        
                        <div id="production"></div>
                    </div>
                    
                    <div class="tab-content" id="warehouse-tab">
                        <!-- 仓库库存图表 -->
                        <div class="chart-section">
                            <div class="chart-header">📦 仓库库存分析</div>
                            <div class="chart-container">
                                <canvas id="warehouseChart"></canvas>
                            </div>
                        </div>
                        <div id="warehouse"></div>
                    </div>
                    
                    <div class="tab-content" id="markets-tab">
                        <!-- 市场价格走势图 -->
                        <div class="chart-section">
                            <div class="chart-header">📈 市场价格走势</div>
                            <div class="chart-container">
                                <canvas id="marketChart"></canvas>
                            </div>
                        </div>
                        <div id="markets"></div>
                    </div>
                    
                    <div class="tab-content" id="finance-tab">
                        <!-- 借贷面板 -->
                        <div class="loan-panel">
                            <div class="batch-header">💰 借贷与杠杆交易</div>
                            <div class="loan-controls">
                                <div>
                                    <input type="number" id="loanAmount" placeholder="借贷金额" min="10000" step="10000" 
                                        style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #9b59b6; background: #2d3436; color: #ddd;">
                                </div>
                                <div class="leverage-selector">
                                    <span style="color: #9b59b6; margin-right: 10px;">杠杆:</span>
                                    <button class="leverage-btn active" data-leverage="1" onclick="game.selectLeverage(1)">1x</button>
                                    <button class="leverage-btn" data-leverage="2" onclick="game.selectLeverage(2)">2x</button>
                                    <button class="leverage-btn" data-leverage="5" onclick="game.selectLeverage(5)">5x</button>
                                    <button class="leverage-btn" data-leverage="10" onclick="game.selectLeverage(10)">10x</button>
                                </div>
                                <button class="btn loan" onclick="game.requestLoan()">申请贷款</button>
                            </div>
                            <div id="loanList"></div>
                        </div>
                        
                        <!-- 金融投资图表 -->
                        <div class="chart-section">
                            <div class="chart-header">💰 投资组合分析</div>
                            <div class="chart-container">
                                <canvas id="financeChart"></canvas>
                            </div>
                        </div>
                        <div id="finance"></div>
                    </div>
                    
                    <div class="tab-content" id="research-tab">
                        <!-- 科技趋势图表 -->
                        <div class="chart-section">
                            <div class="chart-header">🔬 科技研发进度</div>
                            <div class="chart-container">
                                <canvas id="techChart"></canvas>
                            </div>
                        </div>
                        <div id="research"></div>
                    </div>
                </div>
            </div>
            
            <div class="right-panel">
                <div class="chat-section">
                    <div class="chat-header">
                        💬 CEO聊天室
                        <span style="font-size: 12px; color: #bbb;">全球商业交流</span>
                    </div>
                    <div class="chat-messages" id="chatMessages"></div>
                    <div class="chat-input-container">
                        <input type="text" class="chat-input" id="chatInput" placeholder="分享产业心得..." maxlength="200" onkeypress="if(event.key==='Enter') sendMessage()">
                        <button class="chat-send" onclick="sendMessage()">发送</button>
                    </div>
                </div>
                
                <div class="leaderboard">
                    <div class="leaderboard-header">
                        🏆 产业帝国排行榜
                        <span style="font-size: 12px; color: #bbb;">全球企业实时排名</span>
                    </div>
                    <div id="leaderboard"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class ComplexManufacturingTycoon {
            constructor() {
                this.socket = io();
                this.playerId = null;
                this.companyName = '';
                this.playerName = '';
                this.companyType = 'tech';
                this.isConnected = false;
                this.selectedMultiplier = 1;
                this.selectedLeverage = 1;
                this.newsMessages = [];
                this.isBankrupt = false;
                this.powerShortage = false;
                
                // 图表实例
                this.factoryChart = null;
                this.productionChart = null;
                this.marketChart = null;
                this.financeChart = null;
                this.techChart = null;
                this.globalStockChart = null;
                this.warehouseChart = null;
                
                this.gameData = {
                    version: '2.3.0',
                    inventory: { money: 1000000 },
                    factories: {},
                    technologies: [],
                    stockPortfolio: {},
                    shortPositions: {},
                    leveragedPositions: {},
                    loans: [],
                    debt: 0,
                    companyType: 'tech',
                    level: 0,
                    experience: 0,
                    lastUpdate: Date.now(),
                    bankrupt: false
                };
                
                this.productTiers = {};
                this.factoryTypes = {};
                this.marketTiers = {};
                this.techTree = {};
                this.globalMarkets = {};
                this.aiCompanies = [];
                this.leaderboard = [];
                this.chatMessages = [];
                this.selectedCompanyType = 'tech';
                this.globalEvent = null;
                
                this.init();
            }
            
            init() {
                this.setupCompanyTypeSelector();
                this.setupSocketListeners();
                this.initCharts();
                this.startNewsUpdate();
                this.startProductionUpdate();
            }
            
            setupCompanyTypeSelector() {
                const types = document.querySelectorAll('.company-type');
                types.forEach(type => {
                    type.addEventListener('click', () => {
                        types.forEach(t => t.classList.remove('selected'));
                        type.classList.add('selected');
                        this.selectedCompanyType = type.dataset.type;
                    });
                });
                
                // 默认选择科技类型
                const defaultType = document.querySelector('.company-type[data-type="tech"]');
                if (defaultType) {
                    defaultType.classList.add('selected');
                }
            }
            
            initCharts() {
                // 初始化全局股价K线图
                const globalStockCtx = document.getElementById('globalStockChart');
                if (globalStockCtx) {
                    this.globalStockChart = new Chart(globalStockCtx.getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: [],
                            datasets: []
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: {
                                intersect: false,
                                mode: 'index'
                            },
                            plugins: {
                                legend: { 
                                    labels: { color: '#ddd' },
                                    position: 'bottom'
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(0,0,0,0.8)',
                                    titleColor: '#fdcb6e',
                                    bodyColor: '#ddd',
                                    borderColor: '#fdcb6e',
                                    borderWidth: 1
                                }
                            },
                            scales: {
                                x: { 
                                    ticks: { color: '#bbb' }, 
                                    grid: { color: 'rgba(255,255,255,0.1)' }
                                },
                                y: { 
                                    ticks: { 
                                        color: '#bbb',
                                        callback: function(value) {
                                            return '$' + value;
                                        }
                                    }, 
                                    grid: { color: 'rgba(255,255,255,0.1)' }
                                }
                            },
                            elements: {
                                line: {
                                    tension: 0.4
                                },
                                point: {
                                    radius: 0,
                                    hoverRadius: 4
                                }
                            }
                        }
                    });
                }
                
                // 初始化工厂产能图表
                const factoryCtx = document.getElementById('factoryChart');
                if (factoryCtx) {
                    this.factoryChart = new Chart(factoryCtx.getContext('2d'), {
                        type: 'bar',
                        data: {
                            labels: [],
                            datasets: [{
                                label: '工厂数量',
                                data: [],
                                backgroundColor: ['#fdcb6e', '#74b9ff', '#a29bfe', '#fd79a8', '#00b894'],
                                borderColor: '#e17055',
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { labels: { color: '#ddd' } }
                            },
                            scales: {
                                x: { ticks: { color: '#bbb' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                                y: { ticks: { color: '#bbb' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                            }
                        }
                    });
                }

                // 初始化生产进度图表
                const productionCtx = document.getElementById('productionChart');
                if (productionCtx) {
                    this.productionChart = new Chart(productionCtx.getContext('2d'), {
                        type: 'doughnut',
                        data: {
                            labels: ['空闲产能', '生产中', '排队中', '电力不足'],
                            datasets: [{
                                data: [1, 0, 0, 0],
                                backgroundColor: ['#636e72', '#00b894', '#fdcb6e', '#e74c3c'],
                                borderWidth: 2,
                                borderColor: '#2d3436'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { labels: { color: '#ddd' } }
                            }
                        }
                    });
                }

                // 初始化市场价格走势图
                const marketCtx = document.getElementById('marketChart');
                if (marketCtx) {
                    this.marketChart = new Chart(marketCtx.getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: [],
                            datasets: []
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { labels: { color: '#ddd' } }
                            },
                            scales: {
                                x: { 
                                    ticks: { color: '#bbb' }, 
                                    grid: { color: 'rgba(255,255,255,0.1)' }
                                },
                                y: { 
                                    ticks: { 
                                        color: '#bbb',
                                        callback: function(value) {
                                            return value >= 1000000 ? (value / 1000000).toFixed(1) + 'M' : 
                                                   value >= 1000 ? (value / 1000).toFixed(1) + 'K' : value;
                                        }
                                    }, 
                                    grid: { color: 'rgba(255,255,255,0.1)' }
                                }
                            }
                        }
                    });
                }

                // 初始化金融投资图表
                const financeCtx = document.getElementById('financeChart');
                if (financeCtx) {
                    this.financeChart = new Chart(financeCtx.getContext('2d'), {
                        type: 'pie',
                        data: {
                            labels: ['现金', '股票投资', '杠杆持仓', '债务'],
                            datasets: [{
                                data: [100, 0, 0, 0],
                                backgroundColor: ['#fdcb6e', '#00b894', '#9b59b6', '#e74c3c'],
                                borderWidth: 2,
                                borderColor: '#2d3436'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { labels: { color: '#ddd' } }
                            }
                        }
                    });
                }

                // 初始化科技研发进度图表
                const techCtx = document.getElementById('techChart');
                if (techCtx) {
                    this.techChart = new Chart(techCtx.getContext('2d'), {
                        type: 'radar',
                        data: {
                            labels: ['效率', '自动化', '物流', '质量', '电力', 'AI'],
                            datasets: [{
                                label: '研发进度',
                                data: [0, 0, 0, 0, 0, 0],
                                borderColor: '#fdcb6e',
                                backgroundColor: 'rgba(253,203,110,0.2)',
                                pointBackgroundColor: '#fdcb6e',
                                pointBorderColor: '#e17055',
                                pointHoverBackgroundColor: '#e17055',
                                pointHoverBorderColor: '#fdcb6e'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { labels: { color: '#ddd' } }
                            },
                            scales: {
                                r: {
                                    angleLines: { color: 'rgba(255,255,255,0.1)' },
                                    grid: { color: 'rgba(255,255,255,0.1)' },
                                    pointLabels: { color: '#bbb' },
                                    ticks: { color: '#bbb', backdropColor: 'transparent' }
                                }
                            }
                        }
                    });
                }
                
                // 初始化仓库库存图表
                const warehouseCtx = document.getElementById('warehouseChart');
                if (warehouseCtx) {
                    this.warehouseChart = new Chart(warehouseCtx.getContext('2d'), {
                        type: 'bar',
                        data: {
                            labels: [],
                            datasets: [{
                                label: '库存数量',
                                data: [],
                                backgroundColor: '#74b9ff',
                                borderColor: '#0984e3',
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { labels: { color: '#ddd' } }
                            },
                            scales: {
                                x: { 
                                    ticks: { 
                                        color: '#bbb',
                                        maxRotation: 45
                                    }, 
                                    grid: { color: 'rgba(255,255,255,0.1)' }
                                },
                                y: { 
                                    ticks: { color: '#bbb' }, 
                                    grid: { color: 'rgba(255,255,255,0.1)' } 
                                }
                            }
                        }
                    });
                }
            }

            startNewsUpdate() {
                setInterval(() => {
                    this.updateNews();
                }, 15000);
            }

            startProductionUpdate() {
                setInterval(() => {
                    this.updateProductionProgress();
                }, 1000);
            }

            updateNews() {
                const newsTemplates = [
                    "⚡ 全球电力需求激增，发电厂建设潮来临",
                    "🏭 复杂生产链重塑制造业格局",
                    "💰 杠杆交易风险与机遇并存",
                    "📈 AI驱动的智能制造成为趋势",
                    "🔗 供应链依赖关系日益复杂",
                    "💎 奢侈品市场需求持续旺盛",
                    "⚡ 新能源技术突破降低发电成本",
                    "🌍 国际贸易摩擦影响原材料供应"
                ];

                const news = newsTemplates[Math.floor(Math.random() * newsTemplates.length)];
                this.addNewsMessage(news);
            }

            addNewsMessage(message) {
                this.newsMessages.push(message);
                if (this.newsMessages.length > 8) {
                    this.newsMessages.shift();
                }
                
                const newsContent = document.getElementById('newsContent');
                if (newsContent) {
                    newsContent.textContent = this.newsMessages.join(' | ') + ' | ';
                }
            }

            updateProductionProgress() {
                // 实时更新生产进度
                Object.keys(this.gameData.factories).forEach(factoryType => {
                    const factory = this.gameData.factories[factoryType];
                    if (factory.productionTasks) {
                        factory.productionTasks.forEach(task => {
                            if (!task.completed && !task.paused) {
                                const progress = this.calculateTaskProgress(task);
                                task.progress = progress;
                                
                                const progressBar = document.getElementById(`progress_${task.id}`);
                                if (progressBar) {
                                    progressBar.style.width = `${progress * 100}%`;
                                }
                                
                                const timeElement = document.getElementById(`time_${task.id}`);
                                if (timeElement) {
                                    timeElement.textContent = this.formatTime(task.remainingTime || 0);
                                }
                            }
                        });
                    }
                });
                
                this.updateProductionChart();
            }

            calculateTaskProgress(task) {
                if (!task) return 0;
                const elapsed = Date.now() - task.startTime;
                const total = task.completionTime - task.startTime;
                return Math.min(elapsed / total, 1);
            }

            setupSocketListeners() {
                this.socket.on('connect', () => {
                    this.isConnected = true;
                    this.updateConnectionStatus();
                    console.log('🔗 连接到复杂制造系统服务器');
                });
                
                this.socket.on('disconnect', () => {
                    this.isConnected = false;
                    this.updateConnectionStatus();
                    console.log('💔 与服务器断开连接');
                });

                this.socket.on('nameConflict', (data) => {
                    alert(data.message);
                    
                    if (data.suggestion) {
                        const companyInput = document.getElementById('companyName');
                        if (companyInput) {
                            companyInput.value = data.suggestion;
                            companyInput.focus();
                        }
                    }
                    
                    document.getElementById('loginScreen').style.display = 'flex';
                    document.getElementById('gameContainer').style.display = 'none';
                });
                
                this.socket.on('versionReset', (data) => {
                    this.showWelcomeMessage(data.message);
                });
                
                this.socket.on('inheritanceSuccess', (data) => {
                    this.showNotification(`📄 ${data.message}`, 'success');
                    this.showWelcomeBackEffect(data);
                });
                
                this.socket.on('gameState', (data) => {
                    try {
                        this.globalMarkets = data.globalMarkets || {};
                        this.leaderboard = data.leaderboard || [];
                        this.chatMessages = data.chatMessages || [];
                        this.globalEvent = data.globalEvent;
                        this.productTiers = data.productTiers || {};
                        this.factoryTypes = data.factoryTypes || {};
                        this.marketTiers = data.marketTiers || {};
                        this.techTree = data.techTree || {};
                        this.aiCompanies = data.aiCompanies || [];
                        
                        this.renderAll();
                        this.updateGlobalEvent();
                        this.updateGlobalStockChart();
                        this.updateBatchSelectors();
                        console.log('📊 接收到游戏状态数据');
                    } catch (error) {
                        console.error('处理游戏状态数据时出错:', error);
                    }
                });
                
                // 其他Socket监听器保持不变...
                this.socket.on('marketUpdate', (data) => {
                    if (data.marketType) {
                        this.globalMarkets[data.marketType] = data.market;
                    } else {
                        this.globalMarkets = data;
                    }
                    this.renderMarkets();
                    this.updateMarketChart();
                });
                
                this.socket.on('factoryBuilt', (data) => {
                    this.showNotification(`🏭 ${data.message}`, 'success');
                    if (data.playerData) {
                        this.gameData.inventory = data.playerData.inventory || this.gameData.inventory;
                        this.gameData.factories = data.playerData.factories || this.gameData.factories;
                    }
                    this.updateDisplay();
                    this.renderFactories();
                    this.renderProduction();
                    this.updateFactoryChart();
                });
                
                this.socket.on('productionStarted', (data) => {
                    this.showNotification(`⚙️ 开始生产：${this.getProductName(data.task.productId)}`, 'success');
                    if (data.playerData) {
                        this.gameData.inventory = data.playerData.inventory || this.gameData.inventory;
                        this.gameData.factories = data.playerData.factories || this.gameData.factories;
                    }
                    this.updateDisplay();
                    this.renderProduction();
                });
                
                this.socket.on('productionCompleted', (data) => {
                    this.showNotification(`✅ ${data.message}`, 'success');
                    if (data.playerData) {
                        this.gameData.inventory = data.playerData.inventory || this.gameData.inventory;
                        this.gameData.experience = data.playerData.experience || this.gameData.experience;
                    }
                    this.updateDisplay();
                    this.renderProduction();
                    this.updateWarehouseChart();
                });
                
                this.socket.on('error', (data) => {
                    this.showNotification(`❌ ${data.message || '发生错误'}`, 'error');
                });
            }

            // 显示相关方法
            showWelcomeMessage(message) {
                const welcomeDiv = document.createElement('div');
                welcomeDiv.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: linear-gradient(135deg, #00b894, #00a085);
                    color: white;
                    padding: 30px;
                    border-radius: 20px;
                    border: 3px solid #fdcb6e;
                    z-index: 9999;
                    text-align: center;
                    font-size: 16px;
                    font-weight: bold;
                    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
                    animation: bounceIn 0.6s ease-out;
                    max-width: 500px;
                `;
                
                welcomeDiv.innerHTML = `
                    <div style="font-size: 32px; margin-bottom: 15px;">🎉 版本更新！ 🎉</div>
                    <div style="margin-bottom: 15px;">${message}</div>
                    <button onclick="this.parentElement.remove()" style="
                        background: white; color: #00b894; border: none; 
                        padding: 10px 20px; border-radius: 10px; 
                        font-weight: bold; cursor: pointer;">
                        开始体验
                    </button>
                `;
                
                document.body.appendChild(welcomeDiv);
            }

            showWelcomeBackEffect(data) {
                const welcomeDiv = document.createElement('div');
                welcomeDiv.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: linear-gradient(135deg, #fdcb6e, #e17055);
                    color: #2d3436;
                    padding: 30px;
                    border-radius: 20px;
                    border: 3px solid #d63031;
                    z-index: 9999;
                    text-align: center;
                    font-size: 18px;
                    font-weight: bold;
                    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
                    animation: bounceIn 0.6s ease-out;
                `;
                
                welcomeDiv.innerHTML = `
                    <div style="font-size: 32px; margin-bottom: 15px;">🎉 欢迎回来！ 🎉</div>
                    <div style="margin-bottom: 10px;">成功继承产业帝国</div>
                    <div style="font-size: 14px; color: #636e72;">
                        继承价值: ${this.formatNumber(data.inheritedValue)} 💰<br>
                        上次在线: ${new Date(data.lastSeen).toLocaleString()}
                    </div>
                `;
                
                document.body.appendChild(welcomeDiv);
                
                setTimeout(() => {
                    welcomeDiv.remove();
                }, 3000);
            }

            joinGame() {
                const companyInput = document.getElementById('companyName');
                const name = companyInput ? companyInput.value.trim() : '';
                
                if (!name) {
                    alert('请输入你的产业帝国名称！');
                    return;
                }
                
                if (name.length > 25) {
                    alert('公司名称太长了！请控制在25个字符内');
                    return;
                }
                
                if (!/^[a-zA-Z0-9\u4e00-\u9fa5_\-\s]+$/.test(name)) {
                    alert('公司名称只能包含字母、数字、中文、下划线、连字符和空格');
                    return;
                }
                
                this.companyName = name;
                this.companyType = this.selectedCompanyType;
                this.playerName = name + ' CEO';
                this.playerId = 'company_' + Date.now();
                
                this.gameData.companyType = this.companyType;
                
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('gameContainer').style.display = 'block';
                
                const currentCompanyEl = document.getElementById('currentCompany');
                const companyTypeEl = document.getElementById('companyType');
                const playerNameEl = document.getElementById('playerName');
                
                if (currentCompanyEl) currentCompanyEl.textContent = this.companyName;
                if (companyTypeEl) companyTypeEl.textContent = `(${this.companyType})`;
                if (playerNameEl) playerNameEl.textContent = this.playerName;
                
                this.socket.emit('joinGame', {
                    companyName: this.companyName,
                    playerName: this.playerName,
                    companyType: this.companyType,
                    gameData: this.gameData
                });
                
                this.renderAll();
                console.log(`🎮 尝试加入游戏: ${this.companyName}`);
            }

            switchTab(tabName) {
                document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                const targetBtn = document.querySelector(`[onclick="switchTab('${tabName}')"]`);
                if (targetBtn) targetBtn.classList.add('active');
                
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                const targetContent = document.getElementById(`${tabName}-tab`);
                if (targetContent) targetContent.classList.add('active');
                
                // 根据标签页更新对应图表和内容
                switch(tabName) {
                    case 'factories':
                        this.renderFactories();
                        this.updateFactoryChart();
                        break;
                    case 'production':
                        this.renderProduction();
                        this.updateProductionChart();
                        break;
                    case 'warehouse':
                        this.renderWarehouse();
                        this.updateWarehouseChart();
                        break;
                    case 'markets':
                        this.renderMarkets();
                        this.updateMarketChart();
                        break;
                    case 'finance':
                        this.renderFinance();
                        this.updateFinanceChart();
                        break;
                    case 'research':
                        this.renderResearch();
                        this.updateTechChart();
                        break;
                }
            }

            updateGlobalEvent() {
                const banner = document.getElementById('globalEventBanner');
                const text = document.getElementById('globalEventText');
                
                if (this.globalEvent && banner && text) {
                    banner.style.display = 'block';
                    text.innerHTML = `🌍 <strong>${this.globalEvent.name}</strong>: ${this.globalEvent.description}`;
                } else if (banner) {
                    banner.style.display = 'none';
                }
            }

            updateConnectionStatus() {
                const statusElement = document.getElementById('connectionStatus');
                if (statusElement) {
                    if (this.isConnected) {
                        statusElement.textContent = '● 在线';
                        statusElement.style.color = '#00b894';
                    } else {
                        statusElement.textContent = '● 离线';
                        statusElement.style.color = '#d63031';
                    }
                }
            }

            showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.textContent = message;
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.remove();
                }, 4000);
            }

            renderAll() {
                try {
                    this.renderFactories();
                    this.renderProduction();
                    this.renderWarehouse();
                    this.renderMarkets();
                    this.renderFinance();
                    this.renderResearch();
                    this.renderLeaderboard();
                    this.renderChat();
                    this.updateDisplay();
                    this.updateAllCharts();
                } catch (error) {
                    console.error('渲染界面时出错:', error);
                }
            }

            updateAllCharts() {
                try {
                    this.updateFactoryChart();
                    this.updateProductionChart();
                    this.updateWarehouseChart();
                    this.updateMarketChart();
                    this.updateFinanceChart();
                    this.updateTechChart();
                    this.updateGlobalStockChart();
                } catch (error) {
                    console.error('更新图表时出错:', error);
                }
            }

            updateBatchSelectors() {
                try {
                    // 更新批量建造工厂选择器
                    const factorySelect = document.getElementById('batchFactoryType');
                    if (factorySelect && this.factoryTypes) {
                        factorySelect.innerHTML = '<option value="">选择工厂类型</option>';
                        Object.keys(this.factoryTypes).forEach(factoryType => {
                            const factory = this.factoryTypes[factoryType];
                            const option = document.createElement('option');
                            option.value = factoryType;
                            option.textContent = `${factory.emoji || ''} ${factory.name}`;
                            factorySelect.appendChild(option);
                        });
                    }
                    
                    // 更新批量生产产品选择器
                    const productSelect = document.getElementById('batchProductType');
                    if (productSelect && this.productTiers) {
                        productSelect.innerHTML = '<option value="">选择产品</option>';
                        Object.values(this.productTiers).forEach(tier => {
                            Object.keys(tier).forEach(productId => {
                                const product = tier[productId];
                                const option = document.createElement('option');
                                option.value = productId;
                                option.textContent = product.name;
                                productSelect.appendChild(option);
                            });
                        });
                    }
                } catch (error) {
                    console.error('更新批量选择器时出错:', error);
                }
            }

            updateGlobalStockChart() {
                if (!this.globalStockChart || !this.aiCompanies) return;
                
                try {
                    const now = new Date();
                    const timeLabel = now.getHours() + ':' + now.getMinutes().toString().padStart(2, '0');
                    
                    // 限制数据点数量
                    if (this.globalStockChart.data.labels.length >= 50) {
                        this.globalStockChart.data.labels.shift();
                    }
                    this.globalStockChart.data.labels.push(timeLabel);
                    
                    // 显示前6家公司的股价，增加更多变化
                    const topCompanies = [...this.aiCompanies].slice(0, 6);
                    const colors = ['#fdcb6e', '#74b9ff', '#fd79a8', '#00b894', '#a29bfe', '#fab1a0'];
                    
                    topCompanies.forEach((company, index) => {
                        if (!this.globalStockChart.data.datasets[index]) {
                            this.globalStockChart.data.datasets[index] = {
                                label: company.name,
                                data: [],
                                borderColor: colors[index % colors.length],
                                backgroundColor: colors[index % colors.length] + '20',
                                tension: 0.4,
                                fill: false,
                                pointRadius: 0,
                                pointHoverRadius: 4,
                                borderWidth: 2
                            };
                        }
                        
                        const dataset = this.globalStockChart.data.datasets[index];
                        dataset.label = company.name;
                        
                        if (dataset.data.length >= 50) {
                            dataset.data.shift();
                        }
                        
                        dataset.data.push(company.sharePrice || 0);
                    });
                    
                    this.globalStockChart.update('none');
                } catch (error) {
                    console.error('更新股价图表时出错:', error);
                }
            }

            // 渲染方法占位符 - 这里会实现具体的渲染逻辑
            renderFactories() {
                const container = document.getElementById('factories');
                if (!container) return;
                
                container.innerHTML = '<div style="text-align: center; color: #bbb; margin-top: 50px;">工厂建造功能加载中...</div>';
            }
            
            renderProduction() {
                const container = document.getElementById('production');
                if (!container) return;
                
                container.innerHTML = '<div style="text-align: center; color: #bbb; margin-top: 50px;">生产管理功能加载中...</div>';
            }
            
            renderWarehouse() {
                const container = document.getElementById('warehouse');
                if (!container) return;
                
                container.innerHTML = '<div style="text-align: center; color: #bbb; margin-top: 50px;">仓库管理功能加载中...</div>';
            }
            
            renderMarkets() {
                const container = document.getElementById('markets');
                if (!container) return;
                
                container.innerHTML = '<div style="text-align: center; color: #bbb; margin-top: 50px;">市场交易功能加载中...</div>';
            }
            
            renderFinance() {
                const container = document.getElementById('finance');
                if (!container) return;
                
                container.innerHTML = '<div style="text-align: center; color: #bbb; margin-top: 50px;">金融投资功能加载中...</div>';
            }
            
            renderResearch() {
                const container = document.getElementById('research');
                if (!container) return;
                
                container.innerHTML = '<div style="text-align: center; color: #bbb; margin-top: 50px;">科技研发功能加载中...</div>';
            }
            
            renderLeaderboard() {
                const container = document.getElementById('leaderboard');
                if (!container) return;
                
                container.innerHTML = '<div style="text-align: center; color: #bbb; margin-top: 20px;">排行榜加载中...</div>';
            }
            
            renderChat() {
                const container = document.getElementById('chatMessages');
                if (!container) return;
                
                container.innerHTML = '<div style="text-align: center; color: #bbb; margin-top: 20px;">聊天室加载中...</div>';
            }

            // 图表更新方法占位符
            updateFactoryChart() {
                if (!this.factoryChart) return;
                // 工厂图表更新逻辑
            }
            
            updateProductionChart() {
                if (!this.productionChart) return;
                // 生产图表更新逻辑
            }
            
            updateWarehouseChart() {
                if (!this.warehouseChart) return;
                // 仓库图表更新逻辑
            }
            
            updateMarketChart() {
                if (!this.marketChart) return;
                // 市场图表更新逻辑
            }
            
            updateFinanceChart() {
                if (!this.financeChart) return;
                // 金融图表更新逻辑
            }
            
            updateTechChart() {
                if (!this.techChart) return;
                // 科技图表更新逻辑
            }

            updateDisplay() {
                try {
                    // 更新简化的财务状态显示
                    const financeContainer = document.getElementById('financeStatus');
                    if (!financeContainer) return;
                    
                    financeContainer.innerHTML = '';
                    
                    const money = this.gameData.inventory.money || 0;
                    const debt = this.gameData.debt || 0;
                    const netWorth = money - debt;
                    
                    const financeItems = [
                        { 
                            label: '💰 净资产', 
                            value: this.formatNumber(netWorth), 
                            class: netWorth >= 0 ? 'money' : 'debt' 
                        },
                        { 
                            label: '📉 债务', 
                            value: this.formatNumber(debt), 
                            class: 'debt' 
                        },
                        { 
                            label: '⚡ 电力', 
                            value: '充足', 
                            class: 'power'
                        },
                        { 
                            label: '📈 杠杆', 
                            value: '1x', 
                            class: 'leverage' 
                        }
                    ];
                    
                    financeItems.forEach(item => {
                        const div = document.createElement('div');
                        div.className = `finance-item ${item.class}`;
                        div.innerHTML = `${item.label}<br><strong>${item.value}</strong>`;
                        financeContainer.appendChild(div);
                    });
                } catch (error) {
                    console.error('更新显示时出错:', error);
                }
            }

            updateCompanyStats() {
                try {
                    const myCompany = this.leaderboard.find(c => c.name === this.companyName);
                    const myRank = this.leaderboard.findIndex(c => c.name === this.companyName) + 1;
                    
                    const globalRankEl = document.getElementById('globalRank');
                    const onlineCountEl = document.getElementById('onlineCount');
                    const companyValueEl = document.getElementById('companyValue');
                    const companyLevelEl = document.getElementById('companyLevel');
                    
                    if (globalRankEl) globalRankEl.textContent = myRank > 0 ? `#${myRank}` : '#-';
                    if (onlineCountEl) onlineCountEl.textContent = this.leaderboard.filter(c => c.isPlayer && c.online !== false).length;
                    if (companyValueEl) companyValueEl.textContent = myCompany ? this.formatNumber(myCompany.value) : '0';
                    if (companyLevelEl) companyLevelEl.textContent = this.gameData.level;
                } catch (error) {
                    console.error('更新公司统计时出错:', error);
                }
            }

            // 游戏操作方法占位符
            buildFactory(factoryType) {
                this.socket.emit('buildFactory', { factoryType, quantity: 1 });
            }
            
            batchBuildFactory() {
                // 批量建造逻辑
            }
            
            startProduction(factoryType) {
                // 生产逻辑
            }
            
            batchProduction() {
                // 批量生产逻辑
            }
            
            showDependencyChain() {
                // 显示依赖链逻辑
            }
            
            setMultiplier(multiplier) {
                this.selectedMultiplier = multiplier;
            }
            
            selectLeverage(leverage) {
                this.selectedLeverage = leverage;
            }
            
            requestLoan() {
                // 申请贷款逻辑
            }
            
            sendMessage() {
                const input = document.getElementById('chatInput');
                const message = input ? input.value.trim() : '';
                
                if (message && this.companyName) {
                    this.socket.emit('chatMessage', message);
                    input.value = '';
                }
            }

            // 辅助方法
            getProductByKey(productId) {
                for (const tier of Object.values(this.productTiers)) {
                    if (tier[productId]) {
                        return tier[productId];
                    }
                }
                return null;
            }

            getProductName(productId) {
                const product = this.getProductByKey(productId);
                return product ? product.name : productId;
            }

            getProductTier(productId) {
                for (const [tierName, products] of Object.entries(this.productTiers)) {
                    if (products[productId]) {
                        return tierName;
                    }
                }
                return null;
            }

            getCompanyTypeEmoji(companyType) {
                const emojis = {
                    tech: '💻',
                    manufacturing: '🏭',
                    agriculture: '🌾',
                    luxury: '💎',
                    food: '🍔',
                    beauty: '💄',
                    retail: '🛒',
                    finance: '💰',
                    energy: '⚡'
                };
                return emojis[companyType] || '🏢';
            }

            canAfford(cost) {
                if (!cost) return true;
                return Object.keys(cost).every(item => 
                    (this.gameData.inventory[item] || 0) >= cost[item]);
            }

            formatNumber(num) {
                if (!num && num !== 0) return '0';
                if (num >= 1000000000) {
                    return (num / 1000000000).toFixed(1) + 'B';
                } else if (num >= 1000000) {
                    return (num / 1000000).toFixed(1) + 'M';
                } else if (num >= 1000) {
                    return (num / 1000).toFixed(1) + 'K';
                } else {
                    return Math.floor(num).toString();
                }
            }

            formatCost(cost) {
                if (!cost) return '';
                return Object.keys(cost).map(item => {
                    if (item === 'money') {
                        return `${this.formatNumber(cost[item])}💰`;
                    } else {
                        const product = this.getProductByKey(item);
                        return `${this.formatNumber(cost[item])}${product ? product.name : item}`;
                    }
                }).join(' ');
            }

            formatTime(milliseconds) {
                if (!milliseconds) return '0s';
                const seconds = Math.floor(milliseconds / 1000);
                const minutes = Math.floor(seconds / 60);
                const hours = Math.floor(minutes / 60);
                
                if (hours > 0) {
                    return `${hours}h ${minutes % 60}m`;
                } else if (minutes > 0) {
                    return `${minutes}m ${seconds % 60}s`;
                } else {
                    return `${seconds}s`;
                }
            }
        }
        
        // 全局变量
        let game;
        
        // 全局函数
        function joinGame() {
            if (!game) {
                game = new ComplexManufacturingTycoon();
            }
            game.joinGame();
        }
        
        function sendMessage() {
            if (game) {
                game.sendMessage();
            }
        }
        
        function switchTab(tabName) {
            if (game) {
                game.switchTab(tabName);
            }
        }
        
        window.onload = () => {
            game = new ComplexManufacturingTycoon();
        };
        
        // 防止意外关闭
        window.onbeforeunload = () => {
            if (game && game.companyName && !game.isBankrupt) {
                return '确定要离开游戏吗？进度会自动保存。';
            }
        };
    </script>
</body>
</html>
