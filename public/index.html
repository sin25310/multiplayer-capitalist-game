<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é»‘å¿ƒå…¬å¸å¤§äº¨ v2.3 - å¤æ‚ç”Ÿäº§é“¾+å€Ÿè´·ç³»ç»Ÿ</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d3436 50%, #636e72 100%);
            color: #ddd;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* æ–°é—»æ»šåŠ¨æ¡æ ·å¼ */
        .news-ticker {
            background: linear-gradient(90deg, #e17055, #d63031);
            color: white;
            padding: 8px 0;
            white-space: nowrap;
            overflow: hidden;
            border-bottom: 2px solid #fdcb6e;
            font-size: 14px;
            font-weight: bold;
        }
        
        .news-content {
            display: inline-block;
            animation: scroll-left 60s linear infinite;
            padding-left: 100%;
        }
        
        @keyframes scroll-left {
            0% { transform: translate3d(100%, 0, 0); }
            100% { transform: translate3d(-100%, 0, 0); }
        }
        
        /* ç‰ˆæœ¬æ›´æ–°æç¤º */
        .version-banner {
            background: linear-gradient(135deg, #00b894, #00a085);
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: bold;
            border-bottom: 2px solid #fdcb6e;
        }
        
        /* ç ´äº§è­¦å‘Š */
        .bankruptcy-warning {
            background: linear-gradient(135deg, #d63031, #e17055);
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: bold;
            border-bottom: 2px solid #fdcb6e;
            animation: pulse 1s infinite;
        }
        
        /* ç”µåŠ›ä¸è¶³è­¦å‘Š */
        .power-shortage {
            background: linear-gradient(135deg, #fdcb6e, #f39c12);
            color: #2d3436;
            padding: 10px;
            text-align: center;
            font-weight: bold;
            margin: 10px 0;
            border-radius: 8px;
        }
        
        /* è‚¡ä»·Kçº¿å›¾å®¹å™¨ */
        .stock-chart-container {
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        
        .stock-chart-header {
            color: #fdcb6e;
            margin-bottom: 15px;
            font-size: 20px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .stock-chart {
            position: relative;
            height: 200px;
            margin-bottom: 15px;
        }
        
        /* ç™»å½•ç•Œé¢ */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        
        .login-form {
            background: linear-gradient(135deg, #2d3436, #636e72);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.8);
            border: 3px solid #fdcb6e;
            text-align: center;
            color: #ddd;
            max-width: 500px;
            width: 90%;
        }
        
        .login-title {
            font-size: 32px;
            margin-bottom: 10px;
            color: #fdcb6e;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }
        
        .version-tag {
            font-size: 16px;
            color: #00b894;
            margin-bottom: 20px;
            font-weight: bold;
        }
        
        .login-subtitle {
            font-size: 16px;
            margin-bottom: 30px;
            color: #ddd;
            font-style: italic;
        }
        
        .login-input {
            width: 100%;
            padding: 15px;
            margin: 15px 0;
            border: none;
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            color: #ddd;
            font-size: 16px;
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }
        
        .login-input:focus {
            border-color: #fdcb6e;
            outline: none;
            background: rgba(255,255,255,0.15);
        }
        
        .company-type-selector {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 20px 0;
        }
        
        .company-type {
            padding: 15px;
            border: 2px solid rgba(253,203,110,0.3);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(0,0,0,0.3);
        }
        
        .company-type:hover {
            border-color: #fdcb6e;
            background: rgba(253,203,110,0.1);
        }
        
        .company-type.selected {
            border-color: #fdcb6e;
            background: rgba(253,203,110,0.2);
        }
        
        .company-type-title {
            font-weight: bold;
            color: #fdcb6e;
            margin-bottom: 5px;
        }
        
        .company-type-desc {
            font-size: 12px;
            color: #bbb;
        }
        
        .login-btn {
            width: 100%;
            padding: 15px;
            margin: 20px 0;
            border: none;
            border-radius: 8px;
            background: linear-gradient(135deg, #e17055, #d63031);
            color: white;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        
        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(225,112,85,0.4);
        }
        
        .feature-list {
            margin-top: 25px;
            font-size: 14px;
            color: #bbb;
            line-height: 1.8;
            text-align: left;
        }
        
        .feature-item {
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .feature-icon {
            width: 20px;
            font-size: 16px;
        }
        
        /* æ¸¸æˆä¸»ç•Œé¢ */
        .game-container {
            display: none;
            min-height: 100vh;
        }
        
        .header {
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-bottom: 2px solid rgba(253,203,110,0.3);
        }
        
        .company-title {
            text-align: center;
            font-size: 28px;
            margin-bottom: 15px;
            background: linear-gradient(45deg, #fdcb6e, #e17055);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: none;
        }
        
        .company-info {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 20px;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(0,0,0,0.5);
            border-radius: 10px;
        }
        
        .company-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
        }
        
        .stat-item {
            text-align: center;
            padding: 8px;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            border: 1px solid rgba(253,203,110,0.2);
        }
        
        .stat-label {
            font-size: 11px;
            color: #bbb;
            margin-bottom: 3px;
        }
        
        .stat-value {
            font-size: 16px;
            font-weight: bold;
            color: #fdcb6e;
        }
        
        /* èµ„é‡‘çŠ¶æ€ */
        .finance-status {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .finance-item {
            background: linear-gradient(135deg, #2d3436, #636e72);
            color: white;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            font-size: 12px;
            font-weight: bold;
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.3s ease;
        }
        
        .finance-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .finance-item.money { background: linear-gradient(135deg, #fdcb6e, #e17055); }
        .finance-item.debt { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        .finance-item.power { background: linear-gradient(135deg, #f39c12, #e67e22); }
        .finance-item.leverage { background: linear-gradient(135deg, #9b59b6, #8e44ad); }
        
        .global-event-banner {
            background: linear-gradient(135deg, #e17055, #d63031);
            color: white;
            padding: 15px;
            text-align: center;
            margin-bottom: 20px;
            border-radius: 10px;
            border: 2px solid #fdcb6e;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        .main-layout {
            display: grid;
            grid-template-columns: 2fr 1fr;
            min-height: calc(100vh - 200px);
        }
        
        .left-content {
            padding: 20px;
        }
        
        .chart-section {
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        
        .chart-header {
            color: #fdcb6e;
            margin-bottom: 15px;
            font-size: 20px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .chart-container {
            position: relative;
            height: 250px;
            margin-bottom: 15px;
        }
        
        .right-panel {
            background: rgba(0,0,0,0.8);
            border-left: 2px solid rgba(253,203,110,0.3);
            display: flex;
            flex-direction: column;
        }
        
        .chat-section {
            flex: 1;
            padding: 20px;
            border-bottom: 2px solid rgba(253,203,110,0.3);
            min-height: 300px;
        }
        
        .chat-header {
            color: #fdcb6e;
            margin-bottom: 15px;
            font-size: 18px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .chat-messages {
            height: 200px;
            overflow-y: auto;
            margin-bottom: 15px;
            padding: 15px;
            background: rgba(0,0,0,0.5);
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .chat-message {
            margin-bottom: 10px;
            font-size: 13px;
            line-height: 1.4;
            padding: 8px;
            background: rgba(0,0,0,0.3);
            border-radius: 6px;
        }
        
        .chat-time {
            color: #888;
            font-size: 10px;
        }
        
        .chat-player {
            color: #fdcb6e;
            font-weight: bold;
            margin: 0 5px;
        }
        
        .chat-text {
            color: #ddd;
        }
        
        .chat-input-container {
            display: flex;
            gap: 10px;
        }
        
        .chat-input {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            color: #ddd;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .chat-input:focus {
            outline: none;
            border-color: #fdcb6e;
            background: rgba(255,255,255,0.15);
        }
        
        .chat-send {
            padding: 12px 18px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(135deg, #e17055, #d63031);
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .chat-send:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(225,112,85,0.4);
        }
        
        .leaderboard {
            padding: 20px;
            flex: 1;
        }
        
        .leaderboard-header {
            color: #fdcb6e;
            margin-bottom: 15px;
            font-size: 18px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .company-rank {
            display: flex;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            background: linear-gradient(135deg, rgba(45,52,54,0.6), rgba(99,110,114,0.6));
            border-radius: 8px;
            border-left: 3px solid transparent;
            transition: all 0.3s ease;
        }
        
        .company-rank:hover {
            transform: translateX(3px);
        }
        
        .company-rank.player {
            border-left-color: #fdcb6e;
            background: linear-gradient(135deg, rgba(253,203,110,0.15), rgba(225,112,85,0.15));
        }
        
        .company-rank.ai {
            border-left-color: #74b9ff;
        }
        
        .company-rank.bankrupt {
            opacity: 0.5;
            border-left-color: #e74c3c;
        }
        
        .rank-number {
            font-size: 16px;
            font-weight: bold;
            color: #fdcb6e;
            margin-right: 12px;
            min-width: 25px;
        }
        
        .rank-info {
            flex: 1;
        }
        
        .rank-name {
            font-weight: bold;
            color: #ddd;
            margin-bottom: 3px;
            font-size: 13px;
        }
        
        .rank-value {
            font-size: 11px;
            color: #bbb;
        }
        
        .tabs-container {
            background: rgba(0,0,0,0.7);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        
        .tabs-header {
            display: flex;
            background: rgba(0,0,0,0.5);
            overflow-x: auto;
        }
        
        .tab-button {
            flex: 1;
            padding: 15px;
            border: none;
            background: transparent;
            color: #bbb;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            font-weight: bold;
            white-space: nowrap;
            min-width: 120px;
        }
        
        .tab-button:hover {
            color: #fdcb6e;
            background: rgba(253,203,110,0.1);
        }
        
        .tab-button.active {
            color: #fdcb6e;
            border-bottom-color: #fdcb6e;
            background: rgba(253,203,110,0.1);
        }
        
        .tab-content {
            padding: 20px;
            display: none;
            min-height: 400px;
            max-height: 600px;
            overflow-y: auto;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* å·¥å‚ã€å¸‚åœºã€äº§å“é¡¹ç›®æ ·å¼ */
        .factory-item, .market-section, .product-item, .tech-item, .production-item, .stock-item, .loan-item {
            background: linear-gradient(135deg, rgba(45,52,54,0.8), rgba(99,110,114,0.8));
            padding: 15px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            margin-bottom: 12px;
        }
        
        .factory-item:hover, .product-item:hover, .tech-item:hover, .stock-item:hover, .loan-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(253,203,110,0.2);
            border-color: rgba(253,203,110,0.5);
        }
        
        .factory-item.insufficient, .product-item.insufficient, .tech-item.insufficient {
            opacity: 0.6;
            border-color: rgba(214,48,49,0.5);
        }
        
        .factory-item.power-shortage {
            border-color: rgba(241,196,15,0.8);
            background: linear-gradient(135deg, rgba(241,196,15,0.1), rgba(230,126,34,0.1));
        }
        
        .factory-header, .product-header, .tech-header, .production-header, .stock-header, .loan-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .factory-name, .product-name, .tech-name, .production-name, .stock-name, .loan-name {
            font-weight: bold;
            color: #fdcb6e;
            font-size: 16px;
        }
        
        .factory-count, .product-price, .stock-price, .loan-amount {
            background: linear-gradient(135deg, #e17055, #d63031);
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }
        
        /* æ‰¹é‡æ“ä½œæ§åˆ¶é¢æ¿ */
        .batch-controls {
            background: rgba(0,0,0,0.6);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 2px solid #fdcb6e;
        }
        
        .batch-header {
            color: #fdcb6e;
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 18px;
        }
        
        .batch-controls-grid {
            display: grid;
            grid-template-columns: 1fr auto auto;
            gap: 10px;
            align-items: center;
        }
        
        .batch-selector {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .batch-quantity {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
            background: #2d3436;
            color: #ddd;
            width: 80px;
        }
        
        /* å€Ÿè´·é¢æ¿ */
        .loan-panel {
            background: rgba(0,0,0,0.6);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 2px solid #9b59b6;
        }
        
        .loan-controls {
            display: grid;
            grid-template-columns: 1fr auto auto;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .leverage-selector {
            display: flex;
            gap: 5px;
        }
        
        .leverage-btn {
            padding: 6px 10px;
            border: 1px solid #9b59b6;
            background: transparent;
            color: #9b59b6;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.3s ease;
        }
        
        .leverage-btn.active {
            background: #9b59b6;
            color: white;
        }
        
        .leverage-btn:hover {
            background: rgba(155,89,182,0.2);
        }
        
        /* ç”Ÿäº§è¿›åº¦æ¡ */
        .production-progress {
            background: rgba(0,0,0,0.3);
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin: 8px 0;
        }
        
        .production-progress-bar {
            background: linear-gradient(90deg, #00b894, #00a085);
            height: 100%;
            transition: width 0.3s ease;
        }
        
        .production-progress-bar.paused {
            background: linear-gradient(90deg, #fdcb6e, #e17055);
        }
        
        .production-status {
            font-size: 12px;
            color: #00b894;
            margin: 5px 0;
        }
        
        .production-status.paused {
            color: #fdcb6e;
        }
        
        .production-queue {
            font-size: 11px;
            color: #bbb;
            margin-top: 5px;
        }
        
        /* ä¾èµ–å…³ç³»æ˜¾ç¤º */
        .dependency-chain {
            background: rgba(0,0,0,0.3);
            padding: 10px;
            border-radius: 8px;
            margin: 8px 0;
            border-left: 3px solid #74b9ff;
        }
        
        .dependency-item {
            font-size: 11px;
            color: #74b9ff;
            margin: 2px 0;
        }
        
        .dependency-arrow {
            color: #bbb;
            margin: 0 5px;
        }
        
        /* å¸‚åœºç½‘æ ¼ */
        .market-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }
        
        .market-tier {
            background: rgba(0,0,0,0.6);
            border-radius: 10px;
            padding: 15px;
            border: 2px solid rgba(253,203,110,0.3);
        }
        
        .market-tier-header {
            font-weight: bold;
            color: #fdcb6e;
            margin-bottom: 10px;
            font-size: 18px;
        }
        
        .product-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .multiplier-selector {
            display: flex;
            gap: 5px;
            margin: 8px 0;
            justify-content: center;
        }
        
        .multiplier-btn {
            padding: 4px 8px;
            border: 1px solid #fdcb6e;
            background: transparent;
            color: #fdcb6e;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.3s ease;
        }
        
        .multiplier-btn.active {
            background: #fdcb6e;
            color: #2d3436;
        }
        
        .multiplier-btn:hover {
            background: rgba(253,203,110,0.2);
        }
        
        /* è‚¡ç¥¨äº¤æ˜“æ ·å¼ */
        .stock-controls {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
            margin-top: 8px;
        }
        
        .stock-btn {
            padding: 6px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 10px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .stock-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .stock-btn.buy {
            background: linear-gradient(135deg, #00b894, #00a085);
            color: white;
        }
        
        .stock-btn.sell {
            background: linear-gradient(135deg, #e17055, #d63031);
            color: white;
        }
        
        .stock-btn.short {
            background: linear-gradient(135deg, #fd79a8, #e84393);
            color: white;
        }
        
        /* äº§å“ç­‰çº§æ ‡è¯† */
        .tier-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: bold;
            margin-left: 5px;
        }
        
        .tier-badge.BASIC { background: #95a5a6; color: white; }
        .tier-badge.T1 { background: #74b9ff; color: white; }
        .tier-badge.T2 { background: #a29bfe; color: white; }
        .tier-badge.T3 { background: #fd79a8; color: white; }
        .tier-badge.T4 { background: #00b894; color: white; }
        
        .btn {
            background: linear-gradient(135deg, #e17055, #d63031);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            transition: all 0.3s ease;
            margin-top: 8px;
        }
        
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(225,112,85,0.4);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn.buy {
            background: linear-gradient(135deg, #00b894, #00a085);
        }
        
        .btn.sell {
            background: linear-gradient(135deg, #e17055, #d63031);
        }
        
        .btn.build {
            background: linear-gradient(135deg, #fdcb6e, #e17055);
            color: #2d3436;
        }
        
        .btn.loan {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
        }
        
        .btn.batch {
            background: linear-gradient(135deg, #3498db, #2980b9);
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.9);
            color: #fdcb6e;
            padding: 15px 25px;
            border-radius: 10px;
            border: 2px solid #fdcb6e;
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
            max-width: 350px;
        }
        
        .notification.error {
            border-color: #e74c3c;
            color: #e74c3c;
        }
        
        .notification.success {
            border-color: #00b894;
            color: #00b894;
        }
        
        .notification.warning {
            border-color: #f39c12;
            color: #f39c12;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes bounceIn {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.3);
            }
            50% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.05);
            }
            70% {
                transform: translate(-50%, -50%) scale(0.9);
            }
            100% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }
        
        /* äº§å“ä¾èµ–å¼¹çª— */
        .dependency-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .dependency-modal-content {
            background: linear-gradient(135deg, #2d3436, #636e72);
            padding: 30px;
            border-radius: 15px;
            border: 2px solid #fdcb6e;
            max-width: 80%;
            max-height: 80%;
            overflow-y: auto;
            color: #ddd;
        }
        
        .dependency-close {
            float: right;
            font-size: 28px;
            color: #fdcb6e;
            cursor: pointer;
            margin-top: -10px;
            margin-right: -10px;
        }
        
        /* æ»šåŠ¨æ¡æ ·å¼ */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.3);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(253,203,110,0.5);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(253,203,110,0.7);
        }
        
        @media (max-width: 1200px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
            
            .right-panel {
                border-left: none;
                border-top: 2px solid rgba(253,203,110,0.3);
            }
        }
        
        @media (max-width: 768px) {
            .finance-status {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .company-info {
                grid-template-columns: 1fr;
                text-align: center;
            }
            
            .company-type-selector {
                grid-template-columns: 1fr;
            }
            
            .tabs-header {
                justify-content: flex-start;
            }
            
            .market-grid {
                grid-template-columns: 1fr;
            }
            
            .batch-controls-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- ç‰ˆæœ¬æ›´æ–°æ¨ªå¹… -->
    <div class="version-banner">
        ğŸ‰ æ¬¢è¿æ¥åˆ°é»‘å¿ƒå…¬å¸å¤§äº¨ v2.3ï¼å¤æ‚ç”Ÿäº§é“¾ç³»ç»Ÿ + å€Ÿè´·æ æ† + ç ´äº§æœºåˆ¶ï¼ğŸ‰
    </div>

    <!-- æ–°é—»æ»šåŠ¨æ¡ -->
    <div class="news-ticker" id="newsTicker">
        <div class="news-content" id="newsContent">
            ğŸ“° v2.3éœ‡æ’¼å‘å¸ƒï¼šå¤æ‚ç”Ÿäº§ä¾èµ–é“¾ | âš¡ ç”µåŠ›ä¾›åº”ç³»ç»Ÿ | ğŸ’° å€Ÿè´·æ æ†äº¤æ˜“ | ğŸ“‰ ç ´äº§é‡å¼€æœºåˆ¶ | ğŸ”„ æ‰¹é‡å·¥å‚æ“ä½œ | ğŸ“ˆ ç©å®¶è‚¡ç¥¨äº¤æ˜“...
        </div>
    </div>

    <!-- ç™»å½•ç•Œé¢ -->
    <div class="login-screen" id="loginScreen">
        <div class="login-form">
            <div class="login-title">ğŸ¢ é»‘å¿ƒå…¬å¸å¤§äº¨ ğŸ¢</div>
            <div class="version-tag">v2.3 å¤æ‚ç”Ÿäº§é“¾ç³»ç»Ÿ</div>
            <div class="login-subtitle">"ä»ç”µåŠ›åˆ°å¥¢ä¾ˆå“çš„å®Œæ•´äº§ä¸šç”Ÿæ€"</div>
            
            <input type="text" class="login-input" id="companyName" placeholder="è¾“å…¥ä½ çš„äº§ä¸šå¸å›½åç§°" maxlength="25">
            
            <div style="color: #fdcb6e; font-weight: bold; margin: 20px 0 10px 0;">é€‰æ‹©ä½ çš„ä¸“ä¸šæ–¹å‘ï¼š</div>
            <div class="company-type-selector">
                <div class="company-type" data-type="tech">
                    <div class="company-type-title">ğŸ’» ç§‘æŠ€åˆ¶é€ </div>
                    <div class="company-type-desc">ä¸“ç²¾ç”µå­èŠ¯ç‰‡åˆ¶é€ </div>
                </div>
                <div class="company-type" data-type="manufacturing">
                    <div class="company-type-title">ğŸ­ é‡å·¥ä¸š</div>
                    <div class="company-type-desc">é’¢é“æœºæ¢°é‡å·¥åˆ¶é€ </div>
                </div>
                <div class="company-type" data-type="energy">
                    <div class="company-type-title">âš¡ èƒ½æºç”µåŠ›</div>
                    <div class="company-type-desc">ç”µåŠ›ä¾›åº”åŸºç¡€è®¾æ–½</div>
                </div>
                <div class="company-type" data-type="finance">
                    <div class="company-type-title">ğŸ’° é‡‘èæŠ•èµ„</div>
                    <div class="company-type-desc">æ æ†äº¤æ˜“æŠ•èµ„ä¸“å®¶</div>
                </div>
            </div>
            
            <button class="login-btn" onclick="joinGame()">å¼€å§‹äº§ä¸šä¹‹æ—…</button>
            
            <div class="feature-list">
                <div style="color: #fdcb6e; font-weight: bold; margin-bottom: 10px;">ğŸ†• v2.3 é©å‘½æ€§ç‰¹æ€§ï¼š</div>
                <div class="feature-item">
                    <span class="feature-icon">âš¡</span>
                    <span>ç”µåŠ›ä¾èµ–ï¼šæ‰€æœ‰å·¥å‚éœ€è¦ç”µåŠ›æ‰èƒ½è¿è½¬</span>
                </div>
                <div class="feature-item">
                    <span class="feature-icon">ğŸ”—</span>
                    <span>å¤æ‚ç”Ÿäº§é“¾ï¼šè‹¹æœâ†’æœæ±â†’å¯ä¹â†’é¤å…ç­‰ä¾èµ–å…³ç³»</span>
                </div>
                <div class="feature-item">
                    <span class="feature-icon">ğŸ’°</span>
                    <span>å€Ÿè´·æ æ†ï¼šæœ€é«˜10å€æ æ†ï¼Œä»¥å°åšå¤§</span>
                </div>
                <div class="feature-item">
                    <span class="feature-icon">ğŸ“‰</span>
                    <span>ç ´äº§æœºåˆ¶ï¼šèµ„ä¸æŠµå€ºå°†ç ´äº§é‡å¼€</span>
                </div>
                <div class="feature-item">
                    <span class="feature-icon">ğŸ”„</span>
                    <span>æ‰¹é‡æ“ä½œï¼šä¸€é”®æ‰¹é‡å»ºé€ å’Œç”Ÿäº§</span>
                </div>
                <div class="feature-item">
                    <span class="feature-icon">ğŸ“ˆ</span>
                    <span>ç©å®¶è‚¡ç¥¨ï¼šè´­ä¹°å…¶ä»–ç©å®¶å…¬å¸è‚¡ç¥¨</span>
                </div>
            </div>
        </div>
    </div>

    <!-- äº§å“ä¾èµ–å…³ç³»å¼¹çª— -->
    <div class="dependency-modal" id="dependencyModal">
        <div class="dependency-modal-content">
            <span class="dependency-close" onclick="closeDependencyModal()">&times;</span>
            <div id="dependencyContent"></div>
        </div>
    </div>

    <!-- æ¸¸æˆä¸»ç•Œé¢ -->
    <div class="game-container" id="gameContainer">
        <!-- ç ´äº§è­¦å‘Š -->
        <div class="bankruptcy-warning" id="bankruptcyWarning" style="display: none;">
            ğŸ’€ å…¬å¸å·²ç ´äº§ï¼æ‰€æœ‰èµ„äº§å°†è¢«æ¸…ç®—ï¼Œè¯·é‡æ–°å¼€å§‹æ¸¸æˆ ğŸ’€
        </div>
        
        <!-- ç”µåŠ›ä¸è¶³è­¦å‘Š -->
        <div class="power-shortage" id="powerShortage" style="display: none;">
            âš ï¸ ç”µåŠ›ä¸è¶³ï¼ç”Ÿäº§å·²æš‚åœï¼Œè¯·å»ºé€ æ›´å¤šå‘ç”µå‚ âš ï¸
        </div>
        
        <div class="header">
            <div class="company-title">ğŸ­ å¤æ‚äº§ä¸šç”Ÿæ€ï¼šç”µåŠ›é©±åŠ¨çš„åˆ¶é€ å¸å›½ âš¡</div>
            
            <!-- å…¨çƒäº‹ä»¶æ¨ªå¹… -->
            <div class="global-event-banner" id="globalEventBanner" style="display: none;">
                <div id="globalEventText"></div>
            </div>
            
            <div class="company-info">
                <div>
                    <div style="color: #fdcb6e; font-size: 20px; font-weight: bold; margin-bottom: 5px;">
                        <span id="currentCompany">æœªçŸ¥å…¬å¸</span>
                        <span id="companyType" style="font-size: 14px; color: #bbb; margin-left: 10px;">(åˆ¶é€ ä¸š)</span>
                        <span style="background: #00b894; color: white; padding: 4px 8px; border-radius: 10px; font-size: 12px; margin-left: 10px;">
                            Lv.<span id="companyLevel">0</span>
                        </span>
                    </div>
                    <div style="color: #bbb; font-size: 14px;">
                        CEO: <span id="playerName">åŒ¿å</span>
                        <span id="connectionStatus" style="margin-left: 15px; color: #00b894;">â— åœ¨çº¿</span>
                    </div>
                </div>
                
                <div class="company-stats">
                    <div class="stat-item">
                        <div class="stat-label">å…¨çƒæ’å</div>
                        <div class="stat-value" id="globalRank">#-</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">åœ¨çº¿CEO</div>
                        <div class="stat-value" id="onlineCount">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">å…¬å¸ä»·å€¼</div>
                        <div class="stat-value" id="companyValue">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">è‚¡ç¥¨æ”¶ç›Š</div>
                        <div class="stat-value" id="stockReturn">+0%</div>
                    </div>
                </div>
            </div>
            
            <!-- ç®€åŒ–çš„è´¢åŠ¡çŠ¶æ€æ˜¾ç¤º -->
            <div class="finance-status" id="financeStatus">
                <!-- åªæ˜¾ç¤ºèµ„é‡‘ç›¸å…³ä¿¡æ¯ï¼Œå…¶ä»–ç§»åˆ°ä»“åº“é¡µé¢ -->
            </div>
        </div>
        
        <!-- è‚¡ä»·Kçº¿å›¾ -->
        <div class="stock-chart-container">
            <div class="stock-chart-header">
                ğŸ“ˆ å…¨çƒå…¬å¸è‚¡ä»·èµ°åŠ¿ - è·Œå®•èµ·ä¼
                <span style="font-size: 12px; color: #bbb;">æ›´åŠ çœŸå®çš„å¸‚åœºæ³¢åŠ¨</span>
            </div>
            <div class="stock-chart">
                <canvas id="globalStockChart"></canvas>
            </div>
        </div>
        
        <div class="main-layout">
            <div class="left-content">
                <div class="tabs-container">
                    <div class="tabs-header">
                        <button class="tab-button active" onclick="switchTab('factories')">ğŸ­ å·¥å‚å»ºé€ </button>
                        <button class="tab-button" onclick="switchTab('production')">âš™ï¸ ç”Ÿäº§ç®¡ç†</button>
                        <button class="tab-button" onclick="switchTab('warehouse')">ğŸ“¦ ä»“åº“ç®¡ç†</button>
                        <button class="tab-button" onclick="switchTab('markets')">ğŸª å¸‚åœºäº¤æ˜“</button>
                        <button class="tab-button" onclick="switchTab('finance')">ğŸ’° é‡‘èæŠ•èµ„</button>
                        <button class="tab-button" onclick="switchTab('research')">ğŸ”¬ ç§‘æŠ€ç ”å‘</button>
                    </div>
                    
                    <div class="tab-content active" id="factories-tab">
                        <!-- å·¥å‚äº§èƒ½å›¾è¡¨ -->
                        <div class="chart-section">
                            <div class="chart-header">ğŸ“Š å·¥å‚äº§èƒ½åˆ†æ</div>
                            <div class="chart-container">
                                <canvas id="factoryChart"></canvas>
                            </div>
                        </div>
                        
                        <!-- æ‰¹é‡å»ºé€ æ§åˆ¶ -->
                        <div class="batch-controls">
                            <div class="batch-header">ğŸ”„ æ‰¹é‡å»ºé€ å·¥å‚</div>
                            <div class="batch-controls-grid">
                                <div class="batch-selector">
                                    <select id="batchFactoryType" style="padding: 8px; border-radius: 4px; border: 1px solid #ccc; background: #2d3436; color: #ddd;">
                                        <option value="">é€‰æ‹©å·¥å‚ç±»å‹</option>
                                    </select>
                                    <input type="number" id="batchQuantity" class="batch-quantity" placeholder="æ•°é‡" min="1" value="1">
                                </div>
                                <button class="btn batch" onclick="game.batchBuildFactory()">æ‰¹é‡å»ºé€ </button>
                                <button class="btn" onclick="showDependencyChain()">æŸ¥çœ‹ç”Ÿäº§é“¾</button>
                            </div>
                        </div>
                        
                        <div id="factories"></div>
                    </div>
                    
                    <div class="tab-content" id="production-tab">
                        <!-- ç”Ÿäº§è¿›åº¦å›¾è¡¨ -->
                        <div class="chart-section">
                            <div class="chart-header">âš™ï¸ å®æ—¶ç”Ÿäº§ç›‘æ§</div>
                            <div class="chart-container">
                                <canvas id="productionChart"></canvas>
                            </div>
                        </div>
                        
                        <!-- æ‰¹é‡ç”Ÿäº§æ§åˆ¶ -->
                        <div class="batch-controls">
                            <div class="batch-header">ğŸ”„ æ‰¹é‡ç”Ÿäº§æ“ä½œ</div>
                            <div class="batch-controls-grid">
                                <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 10px;">
                                    <select id="batchProductType" style="padding: 8px; border-radius: 4px; border: 1px solid #ccc; background: #2d3436; color: #ddd;">
                                        <option value="">é€‰æ‹©äº§å“</option>
                                    </select>
                                    <input type="number" id="batchProductQuantity" class="batch-quantity" placeholder="æ•°é‡" min="1" value="1">
                                    <button class="btn batch" onclick="game.batchProduction()">æ‰¹é‡ç”Ÿäº§</button>
                                </div>
                            </div>
                        </div>
                        
                        <div id="production"></div>
                    </div>
                    
                    <div class="tab-content" id="warehouse-tab">
                        <!-- ä»“åº“åº“å­˜å›¾è¡¨ -->
                        <div class="chart-section">
                            <div class="chart-header">ğŸ“¦ ä»“åº“åº“å­˜åˆ†æ</div>
                            <div class="chart-container">
                                <canvas id="warehouseChart"></canvas>
                            </div>
                        </div>
                        <div id="warehouse"></div>
                    </div>
                    
                    <div class="tab-content" id="markets-tab">
                        <!-- å¸‚åœºä»·æ ¼èµ°åŠ¿å›¾ -->
                        <div class="chart-section">
                            <div class="chart-header">ğŸ“ˆ å¸‚åœºä»·æ ¼èµ°åŠ¿</div>
                            <div class="chart-container">
                                <canvas id="marketChart"></canvas>
                            </div>
                        </div>
                        <div id="markets"></div>
                    </div>
                    
                    <div class="tab-content" id="finance-tab">
                        <!-- å€Ÿè´·é¢æ¿ -->
                        <div class="loan-panel">
                            <div class="batch-header">ğŸ’° å€Ÿè´·ä¸æ æ†äº¤æ˜“</div>
                            <div class="loan-controls">
                                <div>
                                    <input type="number" id="loanAmount" placeholder="å€Ÿè´·é‡‘é¢" min="10000" step="10000" 
                                        style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #9b59b6; background: #2d3436; color: #ddd;">
                                </div>
                                <div class="leverage-selector">
                                    <span style="color: #9b59b6; margin-right: 10px;">æ æ†:</span>
                                    <button class="leverage-btn active" data-leverage="1" onclick="game.selectLeverage(1)">1x</button>
                                    <button class="leverage-btn" data-leverage="2" onclick="game.selectLeverage(2)">2x</button>
                                    <button class="leverage-btn" data-leverage="5" onclick="game.selectLeverage(5)">5x</button>
                                    <button class="leverage-btn" data-leverage="10" onclick="game.selectLeverage(10)">10x</button>
                                </div>
                                <button class="btn loan" onclick="game.requestLoan()">ç”³è¯·è´·æ¬¾</button>
                            </div>
                            <div id="loanList"></div>
                        </div>
                        
                        <!-- é‡‘èæŠ•èµ„å›¾è¡¨ -->
                        <div class="chart-section">
                            <div class="chart-header">ğŸ’° æŠ•èµ„ç»„åˆåˆ†æ</div>
                            <div class="chart-container">
                                <canvas id="financeChart"></canvas>
                            </div>
                        </div>
                        <div id="finance"></div>
                    </div>
                    
                    <div class="tab-content" id="research-tab">
                        <!-- ç§‘æŠ€è¶‹åŠ¿å›¾è¡¨ -->
                        <div class="chart-section">
                            <div class="chart-header">ğŸ”¬ ç§‘æŠ€ç ”å‘è¿›åº¦</div>
                            <div class="chart-container">
                                <canvas id="techChart"></canvas>
                            </div>
                        </div>
                        <div id="research"></div>
                    </div>
                </div>
            </div>
            
            <div class="right-panel">
                <div class="chat-section">
                    <div class="chat-header">
                        ğŸ’¬ CEOèŠå¤©å®¤
                        <span style="font-size: 12px; color: #bbb;">å…¨çƒå•†ä¸šäº¤æµ</span>
                    </div>
                    <div class="chat-messages" id="chatMessages"></div>
                    <div class="chat-input-container">
                        <input type="text" class="chat-input" id="chatInput" placeholder="åˆ†äº«äº§ä¸šå¿ƒå¾—..." maxlength="200" onkeypress="if(event.key==='Enter') sendMessage()">
                        <button class="chat-send" onclick="sendMessage()">å‘é€</button>
                    </div>
                </div>
                
                <div class="leaderboard">
                    <div class="leaderboard-header">
                        ğŸ† äº§ä¸šå¸å›½æ’è¡Œæ¦œ
                        <span style="font-size: 12px; color: #bbb;">å…¨çƒä¼ä¸šå®æ—¶æ’å</span>
                    </div>
                    <div id="leaderboard"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class ComplexManufacturingTycoon {
            constructor() {
                this.socket = io();
                this.playerId = null;
                this.companyName = '';
                this.playerName = '';
                this.companyType = 'tech';
                this.isConnected = false;
                this.selectedMultiplier = 1;
                this.selectedLeverage = 1;
                this.newsMessages = [];
                this.isBankrupt = false;
                this.powerShortage = false;
                
                // å›¾è¡¨å®ä¾‹
                this.factoryChart = null;
                this.productionChart = null;
                this.marketChart = null;
                this.financeChart = null;
                this.techChart = null;
                this.globalStockChart = null;
                this.warehouseChart = null;
                
                this.gameData = {
                    version: '2.3.1',
                    inventory: { money: 1000000 },
                    factories: {},
                    technologies: [],
                    stockPortfolio: {},
                    shortPositions: {},
                    leveragedPositions: {},
                    loans: [],
                    debt: 0,
                    companyType: 'tech',
                    level: 0,
                    experience: 0,
                    lastUpdate: Date.now(),
                    bankrupt: false
                };
                
                this.productTiers = {};
                this.factoryTypes = {};
                this.marketTiers = {};
                this.techTree = {};
                this.globalMarkets = {};
                this.aiCompanies = [];
                this.playerCompanies = [];
                this.leaderboard = [];
                this.chatMessages = [];
                this.selectedCompanyType = 'tech';
                this.globalEvent = null;
                this.stockPriceHistory = { labels: [], datasets: {} };
                
                this.init();
            }
            
            init() {
                this.setupCompanyTypeSelector();
                this.setupSocketListeners();
                this.initCharts();
                this.startNewsUpdate();
                this.startProductionUpdate();
            }
            
            setupCompanyTypeSelector() {
                const types = document.querySelectorAll('.company-type');
                types.forEach(type => {
                    type.addEventListener('click', () => {
                        types.forEach(t => t.classList.remove('selected'));
                        type.classList.add('selected');
                        this.selectedCompanyType = type.dataset.type;
                    });
                });
                
                // é»˜è®¤é€‰æ‹©ç§‘æŠ€ç±»å‹
                const defaultType = document.querySelector('.company-type[data-type="tech"]');
                if (defaultType) {
                    defaultType.classList.add('selected');
                }
            }
            
            initCharts() {
                // åˆå§‹åŒ–å…¨å±€è‚¡ä»·Kçº¿å›¾
                const globalStockCtx = document.getElementById('globalStockChart');
                if (globalStockCtx) {
                    this.globalStockChart = new Chart(globalStockCtx.getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: [],
                            datasets: []
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: {
                                intersect: false,
                                mode: 'index'
                            },
                            plugins: {
                                legend: { 
                                    labels: { color: '#ddd' },
                                    position: 'bottom'
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(0,0,0,0.8)',
                                    titleColor: '#fdcb6e',
                                    bodyColor: '#ddd',
                                    borderColor: '#fdcb6e',
                                    borderWidth: 1
                                }
                            },
                            scales: {
                                x: { 
                                    ticks: { color: '#bbb' }, 
                                    grid: { color: 'rgba(255,255,255,0.1)' }
                                },
                                y: { 
                                    ticks: { 
                                        color: '#bbb',
                                        callback: function(value) {
                                            return '$' + value;
                                        }
                                    }, 
                                    grid: { color: 'rgba(255,255,255,0.1)' }
                                }
                            },
                            elements: {
                                line: {
                                    tension: 0.4
                                },
                                point: {
                                    radius: 0,
                                    hoverRadius: 4
                                }
                            }
                        }
                    });
                }
                
                // åˆå§‹åŒ–å·¥å‚äº§èƒ½å›¾è¡¨
                const factoryCtx = document.getElementById('factoryChart');
                if (factoryCtx) {
                    this.factoryChart = new Chart(factoryCtx.getContext('2d'), {
                        type: 'bar',
                        data: {
                            labels: [],
                            datasets: [{
                                label: 'å·¥å‚æ•°é‡',
                                data: [],
                                backgroundColor: ['#fdcb6e', '#74b9ff', '#a29bfe', '#fd79a8', '#00b894'],
                                borderColor: '#e17055',
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { labels: { color: '#ddd' } }
                            },
                            scales: {
                                x: { ticks: { color: '#bbb' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                                y: { ticks: { color: '#bbb' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                            }
                        }
                    });
                }

                // åˆå§‹åŒ–ç”Ÿäº§è¿›åº¦å›¾è¡¨
                const productionCtx = document.getElementById('productionChart');
                if (productionCtx) {
                    this.productionChart = new Chart(productionCtx.getContext('2d'), {
                        type: 'doughnut',
                        data: {
                            labels: ['ç©ºé—²äº§èƒ½', 'ç”Ÿäº§ä¸­', 'æ’é˜Ÿä¸­', 'ç”µåŠ›ä¸è¶³'],
                            datasets: [{
                                data: [1, 0, 0, 0],
                                backgroundColor: ['#636e72', '#00b894', '#fdcb6e', '#e74c3c'],
                                borderWidth: 2,
                                borderColor: '#2d3436'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { labels: { color: '#ddd' } }
                            }
                        }
                    });
                }

                // åˆå§‹åŒ–å¸‚åœºä»·æ ¼èµ°åŠ¿å›¾
                const marketCtx = document.getElementById('marketChart');
                if (marketCtx) {
                    this.marketChart = new Chart(marketCtx.getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: [],
                            datasets: []
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { labels: { color: '#ddd' } }
                            },
                            scales: {
                                x: { 
                                    ticks: { color: '#bbb' }, 
                                    grid: { color: 'rgba(255,255,255,0.1)' }
                                },
                                y: { 
                                    ticks: { 
                                        color: '#bbb',
                                        callback: function(value) {
                                            return value >= 1000000 ? (value / 1000000).toFixed(1) + 'M' : 
                                                   value >= 1000 ? (value / 1000).toFixed(1) + 'K' : value;
                                        }
                                    }, 
                                    grid: { color: 'rgba(255,255,255,0.1)' }
                                }
                            }
                        }
                    });
                }

                // åˆå§‹åŒ–é‡‘èæŠ•èµ„å›¾è¡¨
                const financeCtx = document.getElementById('financeChart');
                if (financeCtx) {
                    this.financeChart = new Chart(financeCtx.getContext('2d'), {
                        type: 'pie',
                        data: {
                            labels: ['ç°é‡‘', 'è‚¡ç¥¨æŠ•èµ„', 'æ æ†æŒä»“', 'å€ºåŠ¡'],
                            datasets: [{
                                data: [100, 0, 0, 0],
                                backgroundColor: ['#fdcb6e', '#00b894', '#9b59b6', '#e74c3c'],
                                borderWidth: 2,
                                borderColor: '#2d3436'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { labels: { color: '#ddd' } }
                            }
                        }
                    });
                }

                // åˆå§‹åŒ–ç§‘æŠ€ç ”å‘è¿›åº¦å›¾è¡¨
                const techCtx = document.getElementById('techChart');
                if (techCtx) {
                    this.techChart = new Chart(techCtx.getContext('2d'), {
                        type: 'radar',
                        data: {
                            labels: ['æ•ˆç‡', 'è‡ªåŠ¨åŒ–', 'ç‰©æµ', 'è´¨é‡', 'ç”µåŠ›', 'AI'],
                            datasets: [{
                                label: 'ç ”å‘è¿›åº¦',
                                data: [0, 0, 0, 0, 0, 0],
                                borderColor: '#fdcb6e',
                                backgroundColor: 'rgba(253,203,110,0.2)',
                                pointBackgroundColor: '#fdcb6e',
                                pointBorderColor: '#e17055',
                                pointHoverBackgroundColor: '#e17055',
                                pointHoverBorderColor: '#fdcb6e'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { labels: { color: '#ddd' } }
                            },
                            scales: {
                                r: {
                                    angleLines: { color: 'rgba(255,255,255,0.1)' },
                                    grid: { color: 'rgba(255,255,255,0.1)' },
                                    pointLabels: { color: '#bbb' },
                                    ticks: { color: '#bbb', backdropColor: 'transparent' }
                                }
                            }
                        }
                    });
                }
                
                // åˆå§‹åŒ–ä»“åº“åº“å­˜å›¾è¡¨
                const warehouseCtx = document.getElementById('warehouseChart');
                if (warehouseCtx) {
                    this.warehouseChart = new Chart(warehouseCtx.getContext('2d'), {
                        type: 'bar',
                        data: {
                            labels: [],
                            datasets: [{
                                label: 'åº“å­˜æ•°é‡',
                                data: [],
                                backgroundColor: '#74b9ff',
                                borderColor: '#0984e3',
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { labels: { color: '#ddd' } }
                            },
                            scales: {
                                x: { 
                                    ticks: { 
                                        color: '#bbb',
                                        maxRotation: 45
                                    }, 
                                    grid: { color: 'rgba(255,255,255,0.1)' }
                                },
                                y: { 
                                    ticks: { color: '#bbb' }, 
                                    grid: { color: 'rgba(255,255,255,0.1)' } 
                                }
                            }
                        }
                    });
                }
            }

            startNewsUpdate() {
                setInterval(() => {
                    this.updateNews();
                }, 15000);
            }

            startProductionUpdate() {
                setInterval(() => {
                    this.updateProductionProgress();
                }, 1000);
            }

            updateNews() {
                const newsTemplates = [
                    "âš¡ å…¨çƒç”µåŠ›éœ€æ±‚æ¿€å¢ï¼Œå‘ç”µå‚å»ºè®¾æ½®æ¥ä¸´",
                    "ğŸ­ å¤æ‚ç”Ÿäº§é“¾é‡å¡‘åˆ¶é€ ä¸šæ ¼å±€",
                    "ğŸ’° æ æ†äº¤æ˜“é£é™©ä¸æœºé‡å¹¶å­˜",
                    "ğŸ“ˆ AIé©±åŠ¨çš„æ™ºèƒ½åˆ¶é€ æˆä¸ºè¶‹åŠ¿",
                    "ğŸ”— ä¾›åº”é“¾ä¾èµ–å…³ç³»æ—¥ç›Šå¤æ‚",
                    "ğŸ’ å¥¢ä¾ˆå“å¸‚åœºéœ€æ±‚æŒç»­æ—ºç››",
                    "âš¡ æ–°èƒ½æºæŠ€æœ¯çªç ´é™ä½å‘ç”µæˆæœ¬",
                    "ğŸŒ å›½é™…è´¸æ˜“æ‘©æ“¦å½±å“åŸææ–™ä¾›åº”",
                    "ğŸ“ˆ ç©å®¶å…¬å¸è‚¡ç¥¨äº¤æ˜“æ´»è·ƒ",
                    "ğŸ’° å€Ÿè´·æ”¿ç­–æ”¶ç´§ï¼Œæ æ†å€æ•°å—é™"
                ];

                const news = newsTemplates[Math.floor(Math.random() * newsTemplates.length)];
                this.addNewsMessage(news);
            }

            addNewsMessage(message) {
                this.newsMessages.push(message);
                if (this.newsMessages.length > 8) {
                    this.newsMessages.shift();
                }
                
                const newsContent = document.getElementById('newsContent');
                if (newsContent) {
                    newsContent.textContent = this.newsMessages.join(' | ') + ' | ';
                }
            }

            updateProductionProgress() {
                let hasUpdates = false;
                
                // å®æ—¶æ›´æ–°ç”Ÿäº§è¿›åº¦å’Œèµ„æºæ˜¾ç¤º
                Object.keys(this.gameData.factories).forEach(factoryType => {
                    const factory = this.gameData.factories[factoryType];
                    if (factory.productionTasks) {
                        factory.productionTasks.forEach(task => {
                            if (!task.completed && !task.paused) {
                                const progress = this.calculateTaskProgress(task);
                                task.progress = progress;
                                
                                const progressBar = document.getElementById(`progress_${task.id}`);
                                if (progressBar) {
                                    progressBar.style.width = `${progress * 100}%`;
                                    hasUpdates = true;
                                }
                                
                                const timeElement = document.getElementById(`time_${task.id}`);
                                if (timeElement) {
                                    const remainingTime = task.completionTime ? task.completionTime - Date.now() : 0;
                                    timeElement.textContent = this.formatTime(Math.max(0, remainingTime));
                                    hasUpdates = true;
                                }
                            }
                        });
                    }
                });
                
                if (hasUpdates) {
                    this.updateProductionChart();
                }
                
                // æ›´æ–°èµ„æºæ˜¾ç¤º
                this.updateDisplay();
            }

            calculateTaskProgress(task) {
                if (!task || task.completed) return 1;
                if (!task.startTime || !task.totalTime) return 0;
                
                const elapsed = Date.now() - task.startTime - (task.pausedDuration || 0);
                return Math.min(Math.max(elapsed / task.totalTime, 0), 1);
            }

            setupSocketListeners() {
                this.socket.on('connect', () => {
                    this.isConnected = true;
                    this.updateConnectionStatus();
                    console.log('ğŸ”— è¿æ¥åˆ°å¤æ‚åˆ¶é€ ç³»ç»ŸæœåŠ¡å™¨');
                });
                
                this.socket.on('disconnect', () => {
                    this.isConnected = false;
                    this.updateConnectionStatus();
                    console.log('ğŸ’” ä¸æœåŠ¡å™¨æ–­å¼€è¿æ¥');
                });

                this.socket.on('gameState', (data) => {
                    try {
                        this.globalMarkets = data.globalMarkets || {};
                        this.leaderboard = data.leaderboard || [];
                        this.chatMessages = data.chatMessages || [];
                        this.globalEvent = data.globalEvent;
                        this.productTiers = data.productTiers || {};
                        this.factoryTypes = data.factoryTypes || {};
                        this.marketTiers = data.marketTiers || {};
                        this.techTree = data.techTree || {};
                        this.aiCompanies = data.aiCompanies || [];
                        this.playerCompanies = data.playerCompanies || [];
                        this.stockPriceHistory = data.stockPriceHistory || { labels: [], datasets: {} };
                        
                        this.renderAll();
                        this.updateGlobalEvent();
                        this.updateGlobalStockChart();
                        this.updateBatchSelectors();
                        console.log('ğŸ“Š æ¥æ”¶åˆ°æ¸¸æˆçŠ¶æ€æ•°æ®');
                    } catch (error) {
                        console.error('å¤„ç†æ¸¸æˆçŠ¶æ€æ•°æ®æ—¶å‡ºé”™:', error);
                    }
                });
                
                this.socket.on('marketUpdate', (data) => {
                    if (data.marketType) {
                        this.globalMarkets[data.marketType] = data.market;
                    } else {
                        this.globalMarkets = data;
                    }
                    this.renderMarkets();
                    this.updateMarketChart();
                });
                
                this.socket.on('factoryBuilt', (data) => {
                    this.showNotification(`ğŸ­ ${data.message}`, 'success');
                    if (data.playerData) {
                        this.gameData.inventory = { ...this.gameData.inventory, ...data.playerData.inventory };
                        this.gameData.factories = { ...this.gameData.factories, ...data.playerData.factories };
                    }
                    this.updateDisplay();
                    this.renderFactories();
                    this.renderProduction();
                    this.updateFactoryChart();
                });
                
                this.socket.on('productionStarted', (data) => {
                    this.showNotification(`âš™ï¸ å¼€å§‹ç”Ÿäº§ï¼š${this.getProductName(data.task.productId)}`, 'success');
                    if (data.playerData) {
                        this.gameData.inventory = { ...this.gameData.inventory, ...data.playerData.inventory };
                        this.gameData.factories = { ...this.gameData.factories, ...data.playerData.factories };
                    }
                    this.updateDisplay();
                    this.renderProduction();
                    this.updateWarehouseChart();
                });
                
                this.socket.on('productionCompleted', (data) => {
                    this.showNotification(`âœ… ${data.message}`, 'success');
                    if (data.playerData) {
                        this.gameData.inventory = { ...this.gameData.inventory, ...data.playerData.inventory };
                        this.gameData.experience = data.playerData.experience || this.gameData.experience;
                    }
                    this.updateDisplay();
                    this.renderProduction();
                    this.updateWarehouseChart();
                });
                
                this.socket.on('tradeSuccess', (data) => {
                    this.showNotification(`ğŸ’° ${data.message}`, 'success');
                    if (data.playerData) {
                        this.gameData.inventory = { ...this.gameData.inventory, ...data.playerData.inventory };
                        if (data.playerData.stockPortfolio) {
                            this.gameData.stockPortfolio = data.playerData.stockPortfolio;
                        }
                    }
                    this.updateDisplay();
                    this.renderMarkets();
                    this.renderFinance();
                    this.updateWarehouseChart();
                    this.updateFinanceChart();
                });
                
                this.socket.on('loanApproved', (data) => {
                    this.showNotification(`ğŸ’° ${data.message}`, 'success');
                    if (data.playerData) {
                        this.gameData.inventory = { ...this.gameData.inventory, ...data.playerData.inventory };
                        this.gameData.loans = data.playerData.loans || this.gameData.loans;
                        this.gameData.debt = data.playerData.debt || this.gameData.debt;
                    }
                    this.updateDisplay();
                    this.renderFinance();
                    this.updateFinanceChart();
                });
                
                this.socket.on('loanRepaid', (data) => {
                    this.showNotification(`ğŸ’° ${data.message}`, 'success');
                    if (data.playerData) {
                        this.gameData.inventory = { ...this.gameData.inventory, ...data.playerData.inventory };
                        this.gameData.loans = data.playerData.loans || this.gameData.loans;
                        this.gameData.debt = data.playerData.debt || this.gameData.debt;
                    }
                    this.updateDisplay();
                    this.renderFinance();
                    this.updateFinanceChart();
                });
                
                this.socket.on('techResearched', (data) => {
                    this.showNotification(`ğŸ”¬ ${data.message}`, 'success');
                    if (data.playerData) {
                        this.gameData.inventory = { ...this.gameData.inventory, ...data.playerData.inventory };
                        this.gameData.technologies = data.playerData.technologies || this.gameData.technologies;
                    }
                    this.updateDisplay();
                    this.renderResearch();
                    this.updateTechChart();
                });
                
                // èŠå¤©æ¶ˆæ¯
                this.socket.on('chatMessage', (data) => {
                    this.chatMessages.push(data);
                    if (this.chatMessages.length > 100) {
                        this.chatMessages = this.chatMessages.slice(-50);
                    }
                    this.renderChat();
                });
                
                // æ’è¡Œæ¦œæ›´æ–°
                this.socket.on('leaderboardUpdate', (data) => {
                    this.leaderboard = data;
                    this.renderLeaderboard();
                    this.updateCompanyStats();
                });
                
                // è‚¡ä»·æ›´æ–°
                this.socket.on('stockPricesUpdate', (data) => {
                    this.aiCompanies = data.companies.filter(c => !c.isPlayer) || this.aiCompanies;
                    this.playerCompanies = data.companies.filter(c => c.isPlayer) || this.playerCompanies;
                    this.stockPriceHistory = data.history || this.stockPriceHistory;
                    
                    this.updateGlobalStockChart();
                    this.renderFinance();
                    this.updateFinanceChart();
                });
                
                this.socket.on('error', (data) => {
                    this.showNotification(`âŒ ${data.message || 'å‘ç”Ÿé”™è¯¯'}`, 'error');
                });
            }

            // ç»§ç»­ä¸‹ä¸€éƒ¨åˆ†...

            renderFactories() {
                const container = document.getElementById('factories');
                if (!container || !this.factoryTypes) return;
                
                container.innerHTML = '';
                
                Object.keys(this.factoryTypes).forEach(factoryType => {
                    const factory = this.factoryTypes[factoryType];
                    const div = document.createElement('div');
                    
                    const canAfford = this.canAfford(factory.cost);
                    const ownedFactory = this.gameData.factories[factoryType];
                    const ownedCount = ownedFactory ? ownedFactory.count : 0;
                    
                    div.className = `factory-item ${canAfford ? '' : 'insufficient'}`;
                    
                    // æ˜¾ç¤ºç”Ÿäº§ä¾èµ–å…³ç³»
                    let dependencyInfo = '';
                    if (factory.produces && factory.produces.length > 0) {
                        const sampleProduct = this.getProductByKey(factory.produces[0]);
                        if (sampleProduct && sampleProduct.recipe) {
                            dependencyInfo = `
                                <div class="dependency-chain">
                                    <div style="font-size: 11px; color: #74b9ff; margin-bottom: 5px;">ç”Ÿäº§ä¾èµ–:</div>
                                    ${Object.keys(sampleProduct.recipe).map(material => {
                                        const materialProduct = this.getProductByKey(material);
                                        return `<div class="dependency-item">${materialProduct ? materialProduct.name : material} x${sampleProduct.recipe[material]}</div>`;
                                    }).join('')}
                                </div>
                            `;
                        }
                    }
                    
                    div.innerHTML = `
                        <div class="factory-header">
                            <div class="factory-name">${factory.emoji || 'ğŸ­'} ${factory.name}</div>
                            <div class="factory-count">æ‹¥æœ‰: ${ownedCount}</div>
                        </div>
                        <div style="font-size: 11px; color: #bbb; margin-bottom: 8px;">${factory.description}</div>
                        <div style="font-size: 10px; color: #f39c12; margin-bottom: 8px;">
                            ç”µåŠ›æ¶ˆè€—: ${factory.powerConsumption || 0} âš¡/ç§’
                        </div>
                        <div style="font-size: 12px; color: #ddd; margin-bottom: 8px;">
                            å»ºé€ è´¹ç”¨: ${this.formatCost(factory.cost)}
                        </div>
                        <div style="font-size: 11px; color: #00b894; margin-bottom: 8px;">
                            å¯ç”Ÿäº§: ${factory.produces ? factory.produces.slice(0, 3).map(p => this.getProductName(p)).join(', ') : 'æ— '}${factory.produces && factory.produces.length > 3 ? '...' : ''}
                        </div>
                        ${dependencyInfo}
                        <div style="display: grid; grid-template-columns: 1fr auto; gap: 8px; margin-top: 8px;">
                            <input type="number" id="quantity_${factoryType}" placeholder="æ•°é‡" min="1" value="1" 
                                style="padding: 6px; border-radius: 4px; border: 1px solid #ccc; background: #2d3436; color: #ddd;">
                            <button class="btn build" onclick="game.buildFactory('${factoryType}')" 
                                ${canAfford ? '' : 'disabled'}>
                                å»ºé€ 
                            </button>
                        </div>
                    `;
                    
                    container.appendChild(div);
                });
            }

            renderProduction() {
                const container = document.getElementById('production');
                if (!container) return;
                
                container.innerHTML = '';
                
                if (Object.keys(this.gameData.factories).length === 0) {
                    container.innerHTML = '<div style="text-align: center; color: #bbb; margin-top: 50px;">å…ˆå»ºé€ å·¥å‚æ‰èƒ½å¼€å§‹ç”Ÿäº§</div>';
                    return;
                }
                
                Object.keys(this.gameData.factories).forEach(factoryType => {
                    const factory = this.gameData.factories[factoryType];
                    const factoryTypeData = this.factoryTypes[factory.type];
                    if (!factoryTypeData) return;
                    
                    const div = document.createElement('div');
                    div.className = 'production-item';
                    
                    const activeTasks = (factory.productionTasks || []).filter(task => !task.completed);
                    const maxConcurrent = Math.min(factory.count, 10);
                    const producing = activeTasks.filter(task => !task.paused).length;
                    const paused = activeTasks.filter(task => task.paused).length;
                    const queued = Math.max(0, activeTasks.length - maxConcurrent);
                    
                    let statusText = `${factory.count} ä¸ªå·¥å‚`;
                    if (producing > 0) statusText += `ï¼Œ${producing} ä¸ªç”Ÿäº§ä¸­`;
                    if (paused > 0) statusText += `ï¼Œ${paused} ä¸ªç”µåŠ›ä¸è¶³`;
                    if (queued > 0) statusText += `ï¼Œ${queued} ä¸ªæ’é˜Ÿ`;
                    
                    let progressBars = '';
                    
                    activeTasks.slice(0, 5).forEach(task => {
                        const progress = this.calculateTaskProgress(task);
                        const product = this.getProductByKey(task.productId);
                        const isPaused = task.paused;
                        const remainingTime = task.getRemainingTime ? task.getRemainingTime() : 0;
                        
                        progressBars += `
                            <div style="margin: 8px 0; padding: 8px; background: rgba(0,0,0,0.3); border-radius: 6px;">
                                <div style="font-size: 11px; color: #ddd; margin-bottom: 4px;">
                                    <span onclick="showProductDependency('${task.productId}')" style="cursor: pointer; color: #74b9ff; text-decoration: underline;">
                                        ${product ? product.name : task.productId}
                                    </span> x${task.quantity}
                                </div>
                                <div class="production-progress">
                                    <div class="production-progress-bar ${isPaused ? 'paused' : ''}" 
                                         id="progress_${task.id}" style="width: ${progress * 100}%"></div>
                                </div>
                                <div style="display: flex; justify-content: space-between; font-size: 10px; margin-top: 4px;">
                                    <span class="production-status ${isPaused ? 'paused' : ''}" id="status_${task.id}">
                                        ${isPaused ? 'âš¡ ç”µåŠ›ä¸è¶³' : 'ğŸ”„ ç”Ÿäº§ä¸­'}
                                    </span>
                                    <span style="color: #bbb;">
                                        è¿›åº¦: ${Math.floor(progress * 100)}% | å‰©ä½™: <span id="time_${task.id}">${this.formatTime(remainingTime)}</span>
                                    </span>
                                </div>
                            </div>
                        `;
                    });
                    
                    if (activeTasks.length > 5) {
                        progressBars += `<div style="font-size: 10px; color: #888; margin-top: 5px; text-align: center;">è¿˜æœ‰ ${activeTasks.length - 5} ä¸ªä»»åŠ¡...</div>`;
                    }
                    
                    // è®¡ç®—ç”µåŠ›æ¶ˆè€—
                    const powerConsumption = Math.min(activeTasks.length, factory.count) * (factoryTypeData.powerConsumption || 0);
                    
                    div.innerHTML = `
                        <div class="production-header">
                            <div class="production-name">${factoryTypeData.emoji || 'ğŸ­'} ${factoryTypeData.name}</div>
                            <div style="font-size: 12px; color: #f39c12;">
                                âš¡ ${powerConsumption}/ç§’
                            </div>
                        </div>
                        <div style="font-size: 12px; color: #ddd; margin-bottom: 8px;">
                            çŠ¶æ€: ${statusText}
                        </div>
                        ${progressBars}
                        <div style="margin-top: 10px;">
                            <div style="display: grid; grid-template-columns: 1fr auto auto; gap: 5px; margin-bottom: 8px;">
                                <select id="product_${factoryType}" style="padding: 5px; border-radius: 4px; border: 1px solid #ccc; background: #2d3436; color: #ddd;">
                                    ${factoryTypeData.produces ? factoryTypeData.produces.map(productId => {
                                        const product = this.getProductByKey(productId);
                                        const dependencies = product && product.recipe ? 
                                            Object.keys(product.recipe).map(m => this.getProductName(m)).join('+') : 'æ— ';
                                        return `<option value="${productId}" title="éœ€è¦: ${dependencies}">${product ? product.name : productId}</option>`;
                                    }).join('') : ''}
                                </select>
                                <input type="number" id="quantity_prod_${factoryType}" placeholder="æ•°é‡" min="1" value="1" 
                                    style="width: 60px; padding: 5px; border-radius: 4px; border: 1px solid #ccc; background: #2d3436; color: #ddd;">
                                <button class="btn" onclick="game.startProduction('${factoryType}')" style="padding: 5px 10px;">
                                    ç”Ÿäº§
                                </button>
                            </div>
                            <div style="font-size: 10px; color: #74b9ff;">
                                ç‚¹å‡»äº§å“åç§°æŸ¥çœ‹ä¾èµ–å…³ç³»
                            </div>
                        </div>
                    `;
                    
                    container.appendChild(div);
                });
            }

            renderWarehouse() {
                const container = document.getElementById('warehouse');
                if (!container) return;
                
                container.innerHTML = '';
                
                // æŒ‰ç±»åˆ«åˆ†ç»„æ˜¾ç¤ºåº“å­˜
                const categories = {
                    'BASIC': { name: 'åŸºç¡€èµ„æº', items: [], color: '#95a5a6' },
                    'T1': { name: 'åˆçº§äº§å“', items: [], color: '#74b9ff' },
                    'T2': { name: 'ä¸­çº§äº§å“', items: [], color: '#a29bfe' },
                    'T3': { name: 'é«˜çº§äº§å“', items: [], color: '#fd79a8' },
                    'T4': { name: 'å¥¢ä¾ˆå“', items: [], color: '#00b894' }
                };
                
                Object.keys(this.gameData.inventory).forEach(item => {
                    if (item !== 'money' && this.gameData.inventory[item] > 0) {
                        const tier = this.getProductTier(item);
                        if (tier && categories[tier]) {
                            const product = this.getProductByKey(item);
                            categories[tier].items.push({
                                id: item,
                                name: product ? product.name : item,
                                quantity: this.gameData.inventory[item],
                                price: product ? product.basePrice : 0
                            });
                        }
                    }
                });
                
                Object.keys(categories).forEach(tierKey => {
                    const category = categories[tierKey];
                    if (category.items.length > 0) {
                        const categoryDiv = document.createElement('div');
                        categoryDiv.style.cssText = `
                            background: rgba(0,0,0,0.6);
                            border-radius: 10px;
                            padding: 15px;
                            margin-bottom: 15px;
                            border-left: 4px solid ${category.color};
                        `;
                        
                        let totalValue = category.items.reduce((sum, item) => sum + item.quantity * item.price, 0);
                        
                        categoryDiv.innerHTML = `
                            <div style="color: ${category.color}; font-weight: bold; margin-bottom: 10px; font-size: 16px;">
                                ${category.name} (æ€»ä»·å€¼: ${this.formatNumber(totalValue)} ğŸ’°)
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                                ${category.items.map(item => `
                                    <div style="background: rgba(0,0,0,0.4); padding: 10px; border-radius: 8px; border: 1px solid ${category.color}40;">
                                        <div style="font-weight: bold; color: #ddd; margin-bottom: 4px;">
                                            <span onclick="showProductDependency('${item.id}')" style="cursor: pointer; text-decoration: underline;">${item.name}</span>
                                        </div>
                                        <div style="font-size: 12px; color: #bbb;">
                                            æ•°é‡: <span style="color: ${category.color};">${this.formatNumber(item.quantity)}</span><br>
                                            å•ä»·: ${this.formatNumber(item.price)} ğŸ’°<br>
                                            æ€»å€¼: ${this.formatNumber(item.quantity * item.price)} ğŸ’°
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                        
                        container.appendChild(categoryDiv);
                    }
                });
                
                if (container.innerHTML === '') {
                    container.innerHTML = '<div style="text-align: center; color: #bbb; margin-top: 50px;">ä»“åº“ç©ºç©ºå¦‚ä¹Ÿï¼Œå¿«å»ç”Ÿäº§ä¸€äº›äº§å“å§ï¼</div>';
                }
            }

            renderMarkets() {
                const container = document.getElementById('markets');
                if (!container || !this.globalMarkets || !this.marketTiers) return;
                
                container.innerHTML = '';
                
                const marketGrid = document.createElement('div');
                marketGrid.className = 'market-grid';
                
                Object.keys(this.marketTiers).forEach(marketType => {
                    const marketInfo = this.marketTiers[marketType];
                    const market = this.globalMarkets[marketType] || {};
                    
                    const marketDiv = document.createElement('div');
                    marketDiv.className = 'market-tier';
                    
                    let productsHtml = '';
                    Object.keys(market).forEach(productId => {
                        const productData = market[productId];
                        const product = this.getProductByKey(productId);
                        if (product) {
                            const trendIcon = productData.trend > 0 ? 'ğŸ“ˆ' : productData.trend < 0 ? 'ğŸ“‰' : 'â¡ï¸';
                            const tier = this.getProductTier(productId);
                            
                            // æ˜¾ç¤ºç”Ÿäº§ä¾èµ–
                            let dependencyText = '';
                            if (product.recipe) {
                                dependencyText = `<div style="font-size: 9px; color: #74b9ff; margin: 2px 0;">
                                    éœ€è¦: ${Object.keys(product.recipe).map(m => `${this.getProductName(m)} x${product.recipe[m]}`).join(', ')}
                                </div>`;
                            }
                            
                            productsHtml += `
                                <div class="product-item" style="margin-bottom: 8px; padding: 8px; background: rgba(0,0,0,0.3); border-radius: 6px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span style="font-size: 12px; font-weight: bold;">
                                            <span onclick="showProductDependency('${productId}')" style="cursor: pointer; text-decoration: underline;">${product.name}</span>
                                            <span class="tier-badge ${tier || ''}">${tier || ''}</span>
                                        </span>
                                        <span>${trendIcon}</span>
                                    </div>
                                    ${dependencyText}
                                    <div style="font-size: 11px; color: #bbb; margin: 4px 0;">
                                        ä»·æ ¼: ${this.formatNumber(productData.price)} ğŸ’° | åº“å­˜: ${this.formatNumber(this.gameData.inventory[productId] || 0)}
                                    </div>
                                    <div class="multiplier-selector">
                                        <button class="multiplier-btn ${this.selectedMultiplier === 1 ? 'active' : ''}" onclick="game.setMultiplier(1)">1x</button>
                                        <button class="multiplier-btn ${this.selectedMultiplier === 100 ? 'active' : ''}" onclick="game.setMultiplier(100)">100x</button>
                                        <button class="multiplier-btn ${this.selectedMultiplier === 10000 ? 'active' : ''}" onclick="game.setMultiplier(10000)">10K</button>
                                    </div>
                                    <div style="display: flex; gap: 4px; margin-top: 4px;">
                                        <button class="btn buy" style="flex: 1; padding: 4px; font-size: 10px;" 
                                            onclick="game.buyProduct('${productId}', '${marketType}')">
                                            ä¹°å…¥
                                        </button>
                                        <button class="btn sell" style="flex: 1; padding: 4px; font-size: 10px;" 
                                            onclick="game.sellProduct('${productId}', '${marketType}')">
                                            å–å‡º
                                        </button>
                                    </div>
                                </div>
                            `;
                        }
                    });
                    
                    marketDiv.innerHTML = `
                        <div class="market-tier-header">
                            ${marketInfo.emoji || 'ğŸª'} ${marketInfo.name}
                        </div>
                        <div style="font-size: 11px; color: #bbb; margin-bottom: 10px;">
                            ${marketInfo.description}
                        </div>
                        <div class="product-list">
                            ${productsHtml}
                        </div>
                    `;
                    
                    marketGrid.appendChild(marketDiv);
                });
                
                container.appendChild(marketGrid);
            }

            renderFinance() {
                const container = document.getElementById('finance');
                if (!container) return;
                
                container.innerHTML = '';
                
                // æ˜¾ç¤ºè´·æ¬¾åˆ—è¡¨
                const loanListContainer = document.getElementById('loanList');
                if (loanListContainer) {
                    loanListContainer.innerHTML = '';
                    
                    if (this.gameData.loans && this.gameData.loans.length > 0) {
                        this.gameData.loans.forEach(loan => {
                            const div = document.createElement('div');
                            div.className = 'loan-item';
                            
                            const monthlyRate = (loan.interestRate / 12 * 100).toFixed(2);
                            
                            div.innerHTML = `
                                <div class="loan-header">
                                    <div class="loan-name">ğŸ’° è´·æ¬¾ #${loan.id.slice(-4)}</div>
                                    <div class="loan-amount">${loan.leverage}xæ æ†</div>
                                </div>
                                <div style="font-size: 11px; color: #bbb; margin-bottom: 8px;">
                                    å€Ÿæ¬¾é‡‘é¢: ${this.formatNumber(loan.amount)} ğŸ’°<br>
                                    å¹´åˆ©ç‡: ${(loan.interestRate * 100).toFixed(2)}% | æœˆåˆ©ç‡: ${monthlyRate}%<br>
                                    æœˆè¿˜æ¬¾: ${this.formatNumber(loan.monthlyPayment)} ğŸ’°
                                </div>
                                <button class="btn" onclick="game.repayLoan('${loan.id}', ${Math.min(loan.remainingAmount, this.gameData.inventory.money)})" 
                                    style="width: 100%; font-size: 11px;">
                                    å¿è¿˜è´·æ¬¾
                                </button>
                            `;
                            
                            loanListContainer.appendChild(div);
                        });
                    } else {
                        loanListContainer.innerHTML = '<div style="text-align: center; color: #bbb; font-size: 12px;">æš‚æ— è´·æ¬¾</div>';
                    }
                }
                
                // AIå…¬å¸å’Œç©å®¶å…¬å¸è‚¡ç¥¨åˆ—è¡¨
                const allCompanies = [...this.aiCompanies, ...this.playerCompanies.filter(pc => pc.id !== this.socket.id)];
                
                allCompanies.forEach(company => {
                    const div = document.createElement('div');
                    const ownedShares = this.gameData.stockPortfolio[company.id] || 0;
                    const ownershipPercent = company.totalShares ? ((ownedShares / company.totalShares) * 100).toFixed(2) : '0.00';
                    
                    div.className = 'stock-item';
                    
                    const trendIcon = company.trend > 0 ? 'ğŸ“ˆ' : company.trend < 0 ? 'ğŸ“‰' : 'â¡ï¸';
                    const changePercent = company.lastChange ? (company.lastChange * 100).toFixed(2) : '0.00';
                    
                    // æ˜¾ç¤ºæœ€è¿‘çš„å†²å‡»äº‹ä»¶
                    let shockInfo = '';
                    if (company.shockEvents && company.shockEvents.length > 0) {
                        const latestShock = company.shockEvents[company.shockEvents.length - 1];
                        const timeSince = Date.now() - latestShock.timestamp;
                        if (timeSince < 300000) { // 5åˆ†é’Ÿå†…çš„å†²å‡»äº‹ä»¶
                            shockInfo = `<div style="font-size: 10px; color: ${latestShock.magnitude > 0 ? '#00b894' : '#e74c3c'}; margin-bottom: 4px;">
                                âš¡ ${latestShock.description}
                            </div>`;
                        }
                    }
                    
                    // å¯¹äºç©å®¶å…¬å¸ï¼Œæ˜¾ç¤ºå¯ç”¨è‚¡ä»½
                    let availableInfo = '';
                    if (company.availableShares !== undefined) {
                        availableInfo = `<br>å¯è´­ä¹°: ${this.formatNumber(company.availableShares)}`;
                    }
                    
                    div.innerHTML = `
                        <div class="stock-header">
                            <div class="stock-name">${this.getCompanyTypeEmoji(company.companyType)} ${company.name}</div>
                            <div class="stock-price">$${company.sharePrice}</div>
                        </div>
                        ${shockInfo}
                        <div style="font-size: 11px; color: #bbb; margin-bottom: 8px;">
                            ${company.sector || 'åˆ¶é€ ä¸š'} | æ³¢åŠ¨ç‡: ${((company.volatility || 0.2) * 100).toFixed(1)}%${availableInfo}
                        </div>
                        <div style="font-size: 12px; color: #ddd; margin-bottom: 6px;">
                            æŒè‚¡: ${this.formatNumber(ownedShares)} (${ownershipPercent}%)
                        </div>
                        <div style="font-size: 10px; color: ${parseFloat(changePercent) >= 0 ? '#00b894' : '#e74c3c'}; margin-bottom: 8px;">
                            ${trendIcon} ${parseFloat(changePercent) >= 0 ? '+' : ''}${changePercent}%
                        </div>
                        
                        <div class="multiplier-selector">
                            <span style="color: #bbb; font-size: 11px; margin-right: 10px;">æ•°é‡:</span>
                            <button class="multiplier-btn ${this.selectedMultiplier === 1 ? 'active' : ''}" onclick="game.setMultiplier(1)">1x</button>
                            <button class="multiplier-btn ${this.selectedMultiplier === 100 ? 'active' : ''}" onclick="game.setMultiplier(100)">100x</button>
                            <button class="multiplier-btn ${this.selectedMultiplier === 10000 ? 'active' : ''}" onclick="game.setMultiplier(10000)">10K</button>
                        </div>
                        
                        <div class="leverage-selector" style="margin: 8px 0;">
                            <span style="color: #9b59b6; font-size: 11px; margin-right: 10px;">æ æ†:</span>
                            <button class="leverage-btn ${this.selectedLeverage === 1 ? 'active' : ''}" onclick="game.selectLeverage(1)">1x</button>
                            <button class="leverage-btn ${this.selectedLeverage === 2 ? 'active' : ''}" onclick="game.selectLeverage(2)">2x</button>
                            <button class="leverage-btn ${this.selectedLeverage === 5 ? 'active' : ''}" onclick="game.selectLeverage(5)">5x</button>
                            <button class="leverage-btn ${this.selectedLeverage === 10 ? 'active' : ''}" onclick="game.selectLeverage(10)">10x</button>
                        </div>
                        
                        <div class="stock-controls">
                            <button class="stock-btn buy" onclick="game.buyStock('${company.id}')">
                                ä¹°å…¥
                            </button>
                            <button class="stock-btn sell" onclick="game.sellStock('${company.id}')" 
                                ${ownedShares > 0 ? '' : 'disabled'}>
                                å–å‡º
                            </button>
                            <button class="stock-btn short" onclick="game.shortStock('${company.id}')">
                                åšç©º
                            </button>
                        </div>
                    `;
                    
                    container.appendChild(div);
                });
                
                // æ˜¾ç¤ºæŠ•èµ„ç»„åˆæ€»ç»“
                if (Object.keys(this.gameData.stockPortfolio).length > 0) {
                    const summaryDiv = document.createElement('div');
                    summaryDiv.style.cssText = `
                        background: rgba(0,0,0,0.6);
                        padding: 15px;
                        border-radius: 10px;
                        margin-top: 20px;
                        border: 2px solid #fdcb6e;
                    `;
                    
                    let totalStockValue = 0;
                    let totalInvestment = 0;
                    
                    // æ™®é€šæŒè‚¡ä»·å€¼
                    Object.keys(this.gameData.stockPortfolio).forEach(companyId => {
                        const shares = this.gameData.stockPortfolio[companyId];
                        const targetCompany = allCompanies.find(c => c.id === companyId);
                        if (targetCompany && shares > 0) {
                            totalStockValue += shares * targetCompany.sharePrice;
                            totalInvestment += shares * 100; // å‡è®¾å¹³å‡ä¹°å…¥ä»·æ ¼
                        }
                    });
                    
                    const returnRate = totalInvestment > 0 ? ((totalStockValue - totalInvestment) / totalInvestment * 100) : 0;
                    
                    summaryDiv.innerHTML = `
                        <div style="color: #fdcb6e; font-weight: bold; margin-bottom: 10px;">ğŸ“Š æŠ•èµ„ç»„åˆæ€»ç»“</div>
                        <div style="font-size: 12px; color: #ddd;">
                            æŒè‚¡å¸‚å€¼: ${this.formatNumber(totalStockValue)} ğŸ’°<br>
                            æ€»æ”¶ç›Šç‡: <span style="color: ${returnRate >= 0 ? '#00b894' : '#e74c3c'};">${returnRate >= 0 ? '+' : ''}${returnRate.toFixed(2)}%</span>
                        </div>
                    `;
                    
                    container.appendChild(summaryDiv);
                }
            }

            renderResearch() {
                const container = document.getElementById('research');
                if (!container || !this.techTree) return;
                
                container.innerHTML = '';
                
                Object.keys(this.techTree).forEach(techId => {
                    const tech = this.techTree[techId];
                    const div = document.createElement('div');
                    
                    const canAfford = this.canAfford(tech.cost);
                    const isResearched = this.gameData.technologies.includes(techId);
                    const requirementsMet = !tech.requires || tech.requires.every(reqTech => this.gameData.technologies.includes(reqTech));
                    
                    div.className = `tech-item ${canAfford && requirementsMet && !isResearched ? '' : 'insufficient'}`;
                    
                    let requirementsText = '';
                    if (tech.requires) {
                        requirementsText = `<div style="font-size: 10px; color: #888; margin-bottom: 6px;">
                            å‰ç½®ç§‘æŠ€: ${tech.requires.map(reqTech => 
                                this.techTree[reqTech] ? this.techTree[reqTech].name : reqTech
                            ).join(', ')}
                        </div>`;
                    }
                    
                    div.innerHTML = `
                        <div class="tech-header">
                            <div class="tech-name">ğŸ”¬ ${tech.name}</div>
                            <div style="font-size: 12px; color: ${isResearched ? '#00b894' : '#bbb'};">
                                ${isResearched ? 'âœ… å·²ç ”å‘' : 'ğŸ”¬ å¾…ç ”å‘'}
                            </div>
                        </div>
                        <div style="font-size: 11px; color: #bbb; margin-bottom: 8px;">${tech.description}</div>
                        ${requirementsText}
                        <div style="font-size: 12px; color: #ddd; margin-bottom: 8px;">
                            ç ”å‘è´¹ç”¨: ${this.formatCost(tech.cost)}
                        </div>
                        <div style="font-size: 11px; color: #00b894; margin-bottom: 8px;">
                            æ•ˆæœ: ${tech.effect}
                        </div>
                        <button class="btn" onclick="game.researchTech('${techId}')" 
                            ${canAfford && requirementsMet && !isResearched ? '' : 'disabled'} style="width: 100%;">
                            ${isResearched ? 'å·²ç ”å‘' : 'å¼€å§‹ç ”å‘'}
                        </button>
                    `;
                    
                    container.appendChild(div);
                });
            }

            renderLeaderboard() {
                const container = document.getElementById('leaderboard');
                if (!container) return;
                
                container.innerHTML = '';
                
                this.leaderboard.slice(0, 12).forEach((company, index) => {
                    const div = document.createElement('div');
                    div.className = `company-rank ${company.isPlayer ? 'player' : 'ai'} ${company.debt > company.value ? 'bankrupt' : ''}`;
                    
                    const typeEmoji = this.getCompanyTypeEmoji(company.companyType);
                    const debtRatio = company.debt ? (company.debt / company.value * 100).toFixed(1) : '0';
                    
                    div.innerHTML = `
                        <div class="rank-number">#${index + 1}</div>
                        <div class="rank-info">
                            <div class="rank-name">
                                ${typeEmoji} ${company.name} ${company.isPlayer && company.name === this.companyName ? '(ä½ )' : ''}
                                <span style="font-size: 10px; color: #bbb; margin-left: 5px;">Lv.${company.level || 0}</span>
                                ${company.debt > 0 ? `<span style="font-size: 9px; color: #e74c3c; margin-left: 5px;">è´Ÿå€º${debtRatio}%</span>` : ''}
                            </div>
                            <div class="rank-value">
                                ä»·å€¼: ${this.formatNumber(company.value)} ğŸ’°
                                ${company.sharePrice ? ` | è‚¡ä»·: $${company.sharePrice}` : ''}
                                ${company.debt > 0 ? ` | å€ºåŠ¡: ${this.formatNumber(company.debt)} ğŸ’°` : ''}
                            </div>
                        </div>
                    `;
                    
                    container.appendChild(div);
                });
            }

            renderChat() {
                const container = document.getElementById('chatMessages');
                if (!container) return;
                
                container.innerHTML = '';
                
                this.chatMessages.slice(-15).forEach(msg => {
                    const div = document.createElement('div');
                    div.className = 'chat-message';
                    
                    const time = new Date(msg.timestamp).toLocaleTimeString().slice(0, 5);
                    const isSystem = ['ç³»ç»Ÿ', 'å¸‚åœºå¿«è®¯', 'å…¨çƒäº‹ä»¶', 'é‡‘èå¿«è®¯', 'å·¥ä¸šå¿«è®¯', 'ç§‘æŠ€å¿«è®¯', 'ç”Ÿäº§å¿«è®¯', 'ç ´äº§å…¬å‘Š'].includes(msg.player) || msg.type === 'system';
                    
                    div.innerHTML = `
                        <span class="chat-time">[${time}]</span>
                        <span class="chat-player" style="color: ${isSystem ? '#e17055' : '#fdcb6e'};">${msg.player}:</span>
                        <span class="chat-text">${msg.message}</span>
                    `;
                    
                    container.appendChild(div);
                });
                
                container.scrollTop = container.scrollHeight;
            }

            // ç»§ç»­å®Œæ•´çš„å›¾è¡¨æ›´æ–°æ–¹æ³•
            updateFactoryChart() {
                if (!this.factoryChart) return;
                
                const factoryTypes = {};
                Object.keys(this.gameData.factories).forEach(factoryType => {
                    const factory = this.gameData.factories[factoryType];
                    const type = this.factoryTypes[factory.type];
                    if (type) {
                        factoryTypes[type.name] = factory.count;
                    }
                });
                
                this.factoryChart.data.labels = Object.keys(factoryTypes);
                this.factoryChart.data.datasets[0].data = Object.values(factoryTypes);
                this.factoryChart.update();
            }

            updateProductionChart() {
                if (!this.productionChart) return;
                
                let idle = 0, producing = 0, queued = 0, powerShortage = 0;
                
                Object.keys(this.gameData.factories).forEach(factoryType => {
                    const factory = this.gameData.factories[factoryType];
                    const activeTasks = (factory.productionTasks || []).filter(task => !task.completed);
                    const maxConcurrent = Math.min(factory.count, 10);
                    
                    const pausedTasks = activeTasks.filter(task => task.paused).length;
                    const runningTasks = activeTasks.filter(task => !task.paused).length;
                    
                    producing += Math.min(runningTasks, maxConcurrent);
                    queued += Math.max(0, runningTasks - maxConcurrent);
                    powerShortage += pausedTasks;
                    idle += Math.max(0, factory.count - activeTasks.length);
                });
                
                this.productionChart.data.datasets[0].data = [idle, producing, queued, powerShortage];
                this.productionChart.update();
            }

            updateWarehouseChart() {
                if (!this.warehouseChart) return;
                
                const inventory = this.gameData.inventory || {};
                const labels = [];
                const data = [];
                
                Object.keys(inventory).forEach(item => {
                    if (item !== 'money' && inventory[item] > 0) {
                        const product = this.getProductByKey(item);
                        labels.push(product ? product.name : item);
                        data.push(inventory[item]);
                    }
                });
                
                this.warehouseChart.data.labels = labels.slice(0, 10); // æœ€å¤šæ˜¾ç¤º10ä¸ªäº§å“
                this.warehouseChart.data.datasets[0].data = data.slice(0, 10);
                this.warehouseChart.update();
            }

            updateMarketChart() {
                if (!this.marketChart || !this.globalMarkets.local) return;
                
                const now = new Date();
                const timeLabel = now.getHours() + ':' + now.getMinutes().toString().padStart(2, '0');
                
                if (this.marketChart.data.labels.length >= 20) {
                    this.marketChart.data.labels.shift();
                }
                this.marketChart.data.labels.push(timeLabel);
                
                const trackedProducts = ['electricity', 'steel', 'smartphone', 'luxury_car'];
                const colors = ['#f39c12', '#74b9ff', '#fd79a8', '#fab1a0'];
                
                trackedProducts.forEach((productId, index) => {
                    let price = 0;
                    
                    for (const marketType of Object.keys(this.globalMarkets)) {
                        if (this.globalMarkets[marketType][productId]) {
                            price = this.globalMarkets[marketType][productId].price;
                            break;
                        }
                    }
                    
                    if (!this.marketChart.data.datasets[index]) {
                        this.marketChart.data.datasets[index] = {
                            label: this.getProductName(productId),
                            data: [],
                            borderColor: colors[index],
                            backgroundColor: colors[index] + '20',
                            tension: 0.1,
                            fill: false
                        };
                    }
                    
                    const dataset = this.marketChart.data.datasets[index];
                    
                    if (dataset.data.length >= 20) {
                        dataset.data.shift();
                    }
                    dataset.data.push(price);
                });
                
                this.marketChart.update();
            }

            updateFinanceChart() {
                if (!this.financeChart) return;
                
                const cash = Math.max(0, this.gameData.inventory.money || 0);
                const debt = this.gameData.debt || 0;
                let stockValue = 0;
                
                // è®¡ç®—è‚¡ç¥¨æŠ•èµ„ä»·å€¼
                if (this.gameData.stockPortfolio) {
                    const allCompanies = [...this.aiCompanies, ...this.playerCompanies];
                    Object.keys(this.gameData.stockPortfolio).forEach(companyId => {
                        const shares = this.gameData.stockPortfolio[companyId];
                        const company = allCompanies.find(c => c.id === companyId);
                        if (company && shares > 0) {
                            stockValue += shares * company.sharePrice;
                        }
                    });
                }
                
                this.financeChart.data.datasets[0].data = [cash, stockValue, 0, debt];
                this.financeChart.update();
            }

            updateTechChart() {
                if (!this.techChart) return;
                
                const categories = {
                    'efficiency': 0,
                    'automation': 0,
                    'logistics': 0,
                    'quality': 0,
                    'power': 0,
                    'ai': 0
                };
                
                this.gameData.technologies.forEach(techId => {
                    const tech = this.techTree[techId];
                    if (tech && categories[tech.category] !== undefined) {
                        categories[tech.category]++;
                    }
                });
                
                this.techChart.data.datasets[0].data = Object.values(categories);
                this.techChart.update();
            }

            updateGlobalStockChart() {
                if (!this.globalStockChart) return;
                
                try {
                    this.globalStockChart.data.labels = this.stockPriceHistory.labels || [];
                    
                    // æ¸…ç©ºæ—§æ•°æ®é›†
                    this.globalStockChart.data.datasets = [];
                    
                    // æ·»åŠ æ–°æ•°æ®é›†
                    const colors = ['#fdcb6e', '#74b9ff', '#fd79a8', '#00b894', '#a29bfe', '#fab1a0'];
                    let colorIndex = 0;
                    
                    Object.keys(this.stockPriceHistory.datasets || {}).forEach(companyId => {
                        const dataset = this.stockPriceHistory.datasets[companyId];
                        this.globalStockChart.data.datasets.push({
                            label: dataset.label,
                            data: dataset.data || [],
                            borderColor: colors[colorIndex % colors.length],
                            backgroundColor: colors[colorIndex % colors.length] + '20',
                            tension: 0.4,
                            fill: false,
                            pointRadius: 0,
                            pointHoverRadius: 4,
                            borderWidth: 2
                        });
                        colorIndex++;
                    });
                    
                    this.globalStockChart.update('none');
                } catch (error) {
                    console.error('æ›´æ–°è‚¡ä»·å›¾è¡¨æ—¶å‡ºé”™:', error);
                }
            }

            // æ¸¸æˆæ“ä½œæ–¹æ³•
            joinGame() {
                const companyInput = document.getElementById('companyName');
                const name = companyInput ? companyInput.value.trim() : '';
                
                if (!name) {
                    alert('è¯·è¾“å…¥ä½ çš„äº§ä¸šå¸å›½åç§°ï¼');
                    return;
                }
                
                if (name.length > 25) {
                    alert('å…¬å¸åç§°å¤ªé•¿äº†ï¼è¯·æ§åˆ¶åœ¨25ä¸ªå­—ç¬¦å†…');
                    return;
                }
                
                if (!/^[a-zA-Z0-9\u4e00-\u9fa5_\-\s]+$/.test(name)) {
                    alert('å…¬å¸åç§°åªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—ã€ä¸­æ–‡ã€ä¸‹åˆ’çº¿ã€è¿å­—ç¬¦å’Œç©ºæ ¼');
                    return;
                }
                
                this.companyName = name;
                this.companyType = this.selectedCompanyType;
                this.playerName = name + ' CEO';
                this.playerId = 'company_' + Date.now();
                
                this.gameData.companyType = this.companyType;
                
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('gameContainer').style.display = 'block';
                
                const currentCompanyEl = document.getElementById('currentCompany');
                const companyTypeEl = document.getElementById('companyType');
                const playerNameEl = document.getElementById('playerName');
                
                if (currentCompanyEl) currentCompanyEl.textContent = this.companyName;
                if (companyTypeEl) companyTypeEl.textContent = `(${this.companyType})`;
                if (playerNameEl) playerNameEl.textContent = this.playerName;
                
                this.socket.emit('joinGame', {
                    companyName: this.companyName,
                    playerName: this.playerName,
                    companyType: this.companyType,
                    gameData: this.gameData
                });
                
                this.renderAll();
                console.log(`ğŸ® å°è¯•åŠ å…¥æ¸¸æˆ: ${this.companyName}`);
            }

            switchTab(tabName) {
                document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                const targetBtn = document.querySelector(`[onclick="switchTab('${tabName}')"]`);
                if (targetBtn) targetBtn.classList.add('active');
                
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                const targetContent = document.getElementById(`${tabName}-tab`);
                if (targetContent) targetContent.classList.add('active');
                
                // æ ¹æ®æ ‡ç­¾é¡µæ›´æ–°å¯¹åº”å›¾è¡¨å’Œå†…å®¹
                switch(tabName) {
                    case 'factories':
                        this.renderFactories();
                        this.updateFactoryChart();
                        break;
                    case 'production':
                        this.renderProduction();
                        this.updateProductionChart();
                        break;
                    case 'warehouse':
                        this.renderWarehouse();
                        this.updateWarehouseChart();
                        break;
                    case 'markets':
                        this.renderMarkets();
                        this.updateMarketChart();
                        break;
                    case 'finance':
                        this.renderFinance();
                        this.updateFinanceChart();
                        break;
                    case 'research':
                        this.renderResearch();
                        this.updateTechChart();
                        break;
                }
            }

            updateGlobalEvent() {
                const banner = document.getElementById('globalEventBanner');
                const text = document.getElementById('globalEventText');
                
                if (this.globalEvent && banner && text) {
                    banner.style.display = 'block';
                    text.innerHTML = `ğŸŒ <strong>${this.globalEvent.name}</strong>: ${this.globalEvent.description}`;
                } else if (banner) {
                    banner.style.display = 'none';
                }
            }

            updateConnectionStatus() {
                const statusElement = document.getElementById('connectionStatus');
                if (statusElement) {
                    if (this.isConnected) {
                        statusElement.textContent = 'â— åœ¨çº¿';
                        statusElement.style.color = '#00b894';
                    } else {
                        statusElement.textContent = 'â— ç¦»çº¿';
                        statusElement.style.color = '#d63031';
                    }
                }
            }

            showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.textContent = message;
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.remove();
                }, 4000);
            }

            renderAll() {
                try {
                    this.renderFactories();
                    this.renderProduction();
                    this.renderWarehouse();
                    this.renderMarkets();
                    this.renderFinance();
                    this.renderResearch();
                    this.renderLeaderboard();
                    this.renderChat();
                    this.updateDisplay();
                    this.updateAllCharts();
                } catch (error) {
                    console.error('æ¸²æŸ“ç•Œé¢æ—¶å‡ºé”™:', error);
                }
            }

            updateAllCharts() {
                try {
                    this.updateFactoryChart();
                    this.updateProductionChart();
                    this.updateWarehouseChart();
                    this.updateMarketChart();
                    this.updateFinanceChart();
                    this.updateTechChart();
                    this.updateGlobalStockChart();
                } catch (error) {
                    console.error('æ›´æ–°å›¾è¡¨æ—¶å‡ºé”™:', error);
                }
            }

            updateBatchSelectors() {
                try {
                    // æ›´æ–°æ‰¹é‡å»ºé€ å·¥å‚é€‰æ‹©å™¨
                    const factorySelect = document.getElementById('batchFactoryType');
                    if (factorySelect && this.factoryTypes) {
                        factorySelect.innerHTML = '<option value="">é€‰æ‹©å·¥å‚ç±»å‹</option>';
                        Object.keys(this.factoryTypes).forEach(factoryType => {
                            const factory = this.factoryTypes[factoryType];
                            const option = document.createElement('option');
                            option.value = factoryType;
                            option.textContent = `${factory.emoji || ''} ${factory.name}`;
                            factorySelect.appendChild(option);
                        });
                    }
                    
                    // æ›´æ–°æ‰¹é‡ç”Ÿäº§äº§å“é€‰æ‹©å™¨
                    const productSelect = document.getElementById('batchProductType');
                    if (productSelect && this.productTiers) {
                        productSelect.innerHTML = '<option value="">é€‰æ‹©äº§å“</option>';
                        Object.values(this.productTiers).forEach(tier => {
                            Object.keys(tier).forEach(productId => {
                                const product = tier[productId];
                                const option = document.createElement('option');
                                option.value = productId;
                                option.textContent = product.name;
                                productSelect.appendChild(option);
                            });
                        });
                    }
                } catch (error) {
                    console.error('æ›´æ–°æ‰¹é‡é€‰æ‹©å™¨æ—¶å‡ºé”™:', error);
                }
            }

            // å®Œæ•´çš„æ¸¸æˆæ“ä½œæ–¹æ³•
            buildFactory(factoryType) {
                const quantityInput = document.getElementById(`quantity_${factoryType}`);
                const quantity = parseInt(quantityInput.value) || 1;
                
                this.socket.emit('buildFactory', { factoryType, quantity });
            }

           batchBuildFactory() {
                const factorySelect = document.getElementById('batchFactoryType');
                const quantityInput = document.getElementById('batchQuantity');
                
                const factoryType = factorySelect.value;
                const quantity = parseInt(quantityInput.value) || 1;
                
                if (!factoryType) {
                    this.showNotification('è¯·é€‰æ‹©å·¥å‚ç±»å‹', 'error');
                    return;
                }
                
                this.socket.emit('buildFactory', { factoryType, quantity });
            }

            startProduction(factoryType) {
                const productSelect = document.getElementById(`product_${factoryType}`);
                const quantityInput = document.getElementById(`quantity_prod_${factoryType}`);
                
                const productId = productSelect.value;
                const quantity = parseInt(quantityInput.value) || 1;
                
                this.socket.emit('startProduction', {
                    factoryType: factoryType,
                    productId: productId,
                    quantity: quantity
                });
            }

            batchProduction() {
                const productSelect = document.getElementById('batchProductType');
                const quantityInput = document.getElementById('batchProductQuantity');
                
                const productId = productSelect.value;
                const quantity = parseInt(quantityInput.value) || 1;
                
                if (!productId) {
                    this.showNotification('è¯·é€‰æ‹©äº§å“ç±»å‹', 'error');
                    return;
                }
                
                // æ‰¾åˆ°å¯ä»¥ç”Ÿäº§è¯¥äº§å“çš„æ‰€æœ‰å·¥å‚
                const operations = [];
                Object.keys(this.gameData.factories).forEach(factoryType => {
                    const factory = this.gameData.factories[factoryType];
                    const factoryTypeData = this.factoryTypes[factory.type];
                    
                    if (factoryTypeData && factoryTypeData.produces && factoryTypeData.produces.includes(productId) && factory.count > 0) {
                        operations.push({
                            factoryType: factoryType,
                            productId: productId,
                            quantity: quantity
                        });
                    }
                });
                
                if (operations.length === 0) {
                    this.showNotification('æ²¡æœ‰å¯ä»¥ç”Ÿäº§è¯¥äº§å“çš„å·¥å‚', 'error');
                    return;
                }
                
                // å¯¹æ¯ä¸ªå·¥å‚å‘é€ç”Ÿäº§è¯·æ±‚
                operations.forEach(op => {
                    this.socket.emit('startProduction', op);
                });
            }

            setMultiplier(multiplier) {
                this.selectedMultiplier = multiplier;
                this.renderMarkets();
                this.renderFinance();
            }

            selectLeverage(leverage) {
                this.selectedLeverage = leverage;
                document.querySelectorAll('.leverage-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                const targetBtn = document.querySelector(`[data-leverage="${leverage}"]`);
                if (targetBtn) {
                    targetBtn.classList.add('active');
                }
                this.renderFinance();
            }

            requestLoan() {
                const amountInput = document.getElementById('loanAmount');
                const amount = parseInt(amountInput.value);
                
                if (!amount || amount < 10000) {
                    this.showNotification('è´·æ¬¾é‡‘é¢è‡³å°‘ä¸º 10,000 ğŸ’°', 'error');
                    return;
                }
                
                this.socket.emit('requestLoan', {
                    amount: amount,
                    leverage: this.selectedLeverage
                });
                
                amountInput.value = '';
            }

            repayLoan(loanId, amount) {
                this.socket.emit('repayLoan', {
                    loanId: loanId,
                    amount: amount
                });
            }

            buyProduct(productId, marketType) {
                this.socket.emit('marketTrade', {
                    action: 'buy',
                    productId: productId,
                    quantity: 1,
                    marketType: marketType,
                    multiplier: this.selectedMultiplier
                });
            }

            sellProduct(productId, marketType) {
                this.socket.emit('marketTrade', {
                    action: 'sell',
                    productId: productId,
                    quantity: 1,
                    marketType: marketType,
                    multiplier: this.selectedMultiplier
                });
            }

            buyStock(companyId) {
                this.socket.emit('stockTrade', {
                    action: 'buy',
                    companyId: companyId,
                    shares: 1,
                    multiplier: this.selectedMultiplier,
                    leverage: this.selectedLeverage
                });
            }

            sellStock(companyId) {
                this.socket.emit('stockTrade', {
                    action: 'sell',
                    companyId: companyId,
                    shares: 1,
                    multiplier: this.selectedMultiplier,
                    leverage: this.selectedLeverage
                });
            }

            shortStock(companyId) {
                this.socket.emit('stockTrade', {
                    action: 'short',
                    companyId: companyId,
                    shares: 1,
                    multiplier: this.selectedMultiplier,
                    leverage: this.selectedLeverage
                });
            }

            researchTech(techId) {
                this.socket.emit('researchTech', { techId });
            }

            sendMessage() {
                const input = document.getElementById('chatInput');
                const message = input ? input.value.trim() : '';
                
                if (message && this.companyName) {
                    this.socket.emit('chatMessage', message);
                    input.value = '';
                }
            }

            updateDisplay() {
                try {
                    // æ›´æ–°ç®€åŒ–çš„è´¢åŠ¡çŠ¶æ€æ˜¾ç¤º
                    const financeContainer = document.getElementById('financeStatus');
                    if (!financeContainer) return;
                    
                    financeContainer.innerHTML = '';
                    
                    const money = this.gameData.inventory.money || 0;
                    const debt = this.gameData.debt || 0;
                    const netWorth = money - debt;
                    
                    // è®¡ç®—ç”µåŠ›ä¾›éœ€
                    let powerProduction = 0;
                    let powerConsumption = 0;
                    
                    Object.keys(this.gameData.factories).forEach(factoryType => {
                        const factory = this.gameData.factories[factoryType];
                        const factoryTypeData = this.factoryTypes[factory.type];
                        
                        if (factoryTypeData && factoryTypeData.produces && factoryTypeData.produces.includes('electricity')) {
                            powerProduction += factory.count * 10; // æ¯ä¸ªå‘ç”µå‚äº§10å•ä½ç”µ
                        }
                        
                        if (factory.productionTasks) {
                            const activeTasks = factory.productionTasks.filter(task => !task.completed && !task.paused);
                            const runningTasks = Math.min(activeTasks.length, factory.count);
                            powerConsumption += runningTasks * (factoryTypeData ? factoryTypeData.powerConsumption : 0);
                        }
                    });
                    
                    const powerStatus = powerConsumption <= powerProduction ? 'å……è¶³' : 'ä¸è¶³';
                    
                    // è®¡ç®—æ æ†å€æ•°
                    let totalLeveragedValue = 0;
                    Object.keys(this.gameData.leveragedPositions || {}).forEach(companyId => {
                        const positions = this.gameData.leveragedPositions[companyId] || [];
                        positions.forEach(position => {
                            totalLeveragedValue += position.borrowedAmount;
                        });
                    });
                    
                    const effectiveLeverage = money > 0 ? ((debt + totalLeveragedValue) / money).toFixed(1) : '0';
                    
                    const financeItems = [
                        { 
                            label: 'ğŸ’° å‡€èµ„äº§', 
                            value: this.formatNumber(netWorth), 
                            class: netWorth >= 0 ? 'money' : 'debt' 
                        },
                        { 
                            label: 'ğŸ“‰ å€ºåŠ¡', 
                            value: this.formatNumber(debt), 
                            class: 'debt' 
                        },
                        { 
                            label: 'âš¡ ç”µåŠ›', 
                            value: `${powerProduction}/${powerConsumption}`, 
                            class: 'power',
                            extra: powerStatus
                        },
                        { 
                            label: 'ğŸ“ˆ æ æ†', 
                            value: `${effectiveLeverage}x`, 
                            class: 'leverage' 
                        }
                    ];
                    
                    financeItems.forEach(item => {
                        const div = document.createElement('div');
                        div.className = `finance-item ${item.class}`;
                        div.innerHTML = `${item.label}<br><strong>${item.value}</strong>${item.extra ? `<br><span style="font-size: 10px;">${item.extra}</span>` : ''}`;
                        financeContainer.appendChild(div);
                    });
                    
                    // æ›´æ–°ç”µåŠ›ä¸è¶³è­¦å‘Š
                    if (powerConsumption > powerProduction && !this.powerShortage) {
                        this.powerShortage = true;
                        document.getElementById('powerShortage').style.display = 'block';
                    } else if (powerConsumption <= powerProduction && this.powerShortage) {
                        this.powerShortage = false;
                        document.getElementById('powerShortage').style.display = 'none';
                    }
                } catch (error) {
                    console.error('æ›´æ–°æ˜¾ç¤ºæ—¶å‡ºé”™:', error);
                }
            }

            updateCompanyStats() {
                try {
                    const myCompany = this.leaderboard.find(c => c.name === this.companyName);
                    const myRank = this.leaderboard.findIndex(c => c.name === this.companyName) + 1;
                    
                    const globalRankEl = document.getElementById('globalRank');
                    const onlineCountEl = document.getElementById('onlineCount');
                    const companyValueEl = document.getElementById('companyValue');
                    const companyLevelEl = document.getElementById('companyLevel');
                    
                    if (globalRankEl) globalRankEl.textContent = myRank > 0 ? `#${myRank}` : '#-';
                    if (onlineCountEl) onlineCountEl.textContent = this.leaderboard.filter(c => c.isPlayer && c.online !== false).length;
                    if (companyValueEl) companyValueEl.textContent = myCompany ? this.formatNumber(myCompany.value) : '0';
                    if (companyLevelEl) companyLevelEl.textContent = this.gameData.level;
                    
                    // è®¡ç®—è‚¡ç¥¨æ”¶ç›Šç‡
                    let totalReturn = 0;
                    let totalInvestment = 0;
                    
                    if (this.gameData.stockPortfolio) {
                        const allCompanies = [...this.aiCompanies, ...this.playerCompanies];
                        Object.keys(this.gameData.stockPortfolio).forEach(companyId => {
                            const shares = this.gameData.stockPortfolio[companyId];
                            const company = allCompanies.find(c => c.id === companyId);
                            if (company && shares > 0) {
                                totalReturn += shares * company.sharePrice;
                                totalInvestment += shares * 100; // å‡è®¾å¹³å‡ä¹°å…¥ä»·
                            }
                        });
                    }
                    
                    const returnPercent = totalInvestment > 0 ? ((totalReturn - totalInvestment) / totalInvestment * 100) : 0;
                    const stockReturnElement = document.getElementById('stockReturn');
                    if (stockReturnElement) {
                        stockReturnElement.textContent = `${returnPercent >= 0 ? '+' : ''}${returnPercent.toFixed(1)}%`;
                        stockReturnElement.style.color = returnPercent >= 0 ? '#00b894' : '#e74c3c';
                    }
                } catch (error) {
                    console.error('æ›´æ–°å…¬å¸ç»Ÿè®¡æ—¶å‡ºé”™:', error);
                }
            }

            // è¾…åŠ©æ–¹æ³•
            getProductByKey(productId) {
                for (const tier of Object.values(this.productTiers)) {
                    if (tier[productId]) {
                        return tier[productId];
                    }
                }
                return null;
            }

            getProductName(productId) {
                const product = this.getProductByKey(productId);
                return product ? product.name : productId;
            }

            getProductTier(productId) {
                for (const [tierName, products] of Object.entries(this.productTiers)) {
                    if (products[productId]) {
                        return tierName;
                    }
                }
                return null;
            }

            getCompanyTypeEmoji(companyType) {
                const emojis = {
                    tech: 'ğŸ’»',
                    manufacturing: 'ğŸ­',
                    agriculture: 'ğŸŒ¾',
                    luxury: 'ğŸ’',
                    food: 'ğŸ”',
                    beauty: 'ğŸ’„',
                    retail: 'ğŸ›’',
                    finance: 'ğŸ’°',
                    energy: 'âš¡'
                };
                return emojis[companyType] || 'ğŸ¢';
            }

            canAfford(cost) {
                if (!cost) return true;
                return Object.keys(cost).every(item => 
                    (this.gameData.inventory[item] || 0) >= cost[item]);
            }

            formatNumber(num) {
                if (!num && num !== 0) return '0';
                if (num >= 1000000000) {
                    return (num / 1000000000).toFixed(1) + 'B';
                } else if (num >= 1000000) {
                    return (num / 1000000).toFixed(1) + 'M';
                } else if (num >= 1000) {
                    return (num / 1000).toFixed(1) + 'K';
                } else {
                    return Math.floor(num).toString();
                }
            }

            formatCost(cost) {
                if (!cost) return '';
                return Object.keys(cost).map(item => {
                    if (item === 'money') {
                        return `${this.formatNumber(cost[item])}ğŸ’°`;
                    } else {
                        const product = this.getProductByKey(item);
                        return `${this.formatNumber(cost[item])}${product ? product.name : item}`;
                    }
                }).join(' ');
            }

            formatTime(milliseconds) {
                if (!milliseconds) return '0s';
                const seconds = Math.floor(milliseconds / 1000);
                const minutes = Math.floor(seconds / 60);
                const hours = Math.floor(minutes / 60);
                
                if (hours > 0) {
                    return `${hours}h ${minutes % 60}m`;
                } else if (minutes > 0) {
                    return `${minutes}m ${seconds % 60}s`;
                } else {
                    return `${seconds}s`;
                }
            }

            // æ„å»ºä¾èµ–é“¾æ–¹æ³•
            buildDependencyChain(productId, visited) {
                if (visited.has(productId)) {
                    return [this.getProductName(productId) + ' (å¾ªç¯)'];
                }
                
                visited.add(productId);
                const product = this.getProductByKey(productId);
                
                if (!product || !product.recipe) {
                    return [this.getProductName(productId)];
                }
                
                const chain = [this.getProductName(productId)];
                const dependencies = [];
                
                Object.keys(product.recipe).forEach(materialId => {
                    const subChain = this.buildDependencyChain(materialId, new Set(visited));
                    dependencies.push(subChain[subChain.length - 1]);
                });
                
                return [...dependencies, ...chain];
            }
        }
        
        // å…¨å±€å˜é‡
        let game;
        
        // å…¨å±€å‡½æ•°
        function joinGame() {
            if (!game) {
                game = new ComplexManufacturingTycoon();
            }
            game.joinGame();
        }
        
        function sendMessage() {
            if (game) {
                game.sendMessage();
            }
        }
        
        function switchTab(tabName) {
            if (game) {
                game.switchTab(tabName);
            }
        }
        
        // æ˜¾ç¤ºäº§å“ä¾èµ–å…³ç³»
        function showProductDependency(productId) {
            const modal = document.getElementById('dependencyModal');
            const content = document.getElementById('dependencyContent');
            
            if (!modal || !content || !game) return;
            
            const product = game.getProductByKey(productId);
            if (!product) return;
            
            let html = `
                <h2 style="color: #fdcb6e; margin-bottom: 20px;">ğŸ“¦ ${product.name} - ç”Ÿäº§ä¾èµ–å…³ç³»</h2>
                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <div style="font-size: 14px; color: #ddd; margin-bottom: 8px;">
                        <strong>åŸºç¡€ä¿¡æ¯:</strong><br>
                        ç±»åˆ«: ${product.category}<br>
                        åŸºç¡€ä»·æ ¼: ${product.basePrice} ğŸ’°<br>
                        ç”Ÿäº§æ—¶é—´: ${product.productionTime} ç§’
                    </div>
                </div>
            `;
            
            if (product.recipe) {
                html += `
                    <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h3 style="color: #74b9ff; margin-bottom: 10px;">ğŸ”— ç›´æ¥ä¾èµ–:</h3>
                `;
                
                Object.keys(product.recipe).forEach(materialId => {
                    const material = game.getProductByKey(materialId);
                    const quantity = product.recipe[materialId];
                    html += `
                        <div style="margin: 5px 0; padding: 8px; background: rgba(0,0,0,0.3); border-radius: 4px;">
                            <span onclick="showProductDependency('${materialId}')" 
                                  style="cursor: pointer; color: #74b9ff; text-decoration: underline;">
                                ${material ? material.name : materialId}
                            </span>
                            <span style="color: #fdcb6e;"> x${quantity}</span>
                        </div>
                    `;
                });
                
                html += '</div>';
                
                // é€’å½’æ˜¾ç¤ºå®Œæ•´ä¾èµ–é“¾
                const dependencyChain = game.buildDependencyChain(productId, new Set());
                if (dependencyChain.length > 1) {
                    html += `
                        <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px;">
                            <h3 style="color: #fd79a8; margin-bottom: 10px;">ğŸŒ å®Œæ•´ä¾èµ–é“¾:</h3>
                            <div style="font-size: 12px; line-height: 1.6;">
                                ${dependencyChain.join(' â†’ ')}
                            </div>
                        </div>
                    `;
                }
            } else {
                html += `
                    <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; text-align: center; color: #00b894;">
                        âœ… è¿™æ˜¯åŸºç¡€èµ„æºï¼Œæ— éœ€å…¶ä»–ææ–™
                    </div>
                `;
            }
            
            content.innerHTML = html;
            modal.style.display = 'flex';
        }
        
        // å…³é—­ä¾èµ–å…³ç³»å¼¹çª—
        function closeDependencyModal() {
            const modal = document.getElementById('dependencyModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // æ˜¾ç¤ºç”Ÿäº§é“¾
        function showDependencyChain() {
            if (!game) return;
            
            const modal = document.getElementById('dependencyModal');
            const content = document.getElementById('dependencyContent');
            
            if (!modal || !content) return;
            
            let html = `
                <h2 style="color: #fdcb6e; margin-bottom: 20px;">ğŸ”— å®Œæ•´ç”Ÿäº§ä¾èµ–å…³ç³»å›¾</h2>
            `;
            
            Object.keys(game.productTiers).forEach(tier => {
                html += `
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: #74b9ff; margin-bottom: 10px; font-size: 18px;">${tier} çº§äº§å“</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 10px;">
                `;
                
                Object.keys(game.productTiers[tier]).forEach(productId => {
                    const product = game.productTiers[tier][productId];
                    html += `
                        <div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 6px; border-left: 3px solid #74b9ff;">
                            <div style="font-weight: bold; color: #fdcb6e; margin-bottom: 5px;">
                                <span onclick="showProductDependency('${productId}')" 
                                      style="cursor: pointer; text-decoration: underline;">
                                    ${product.name}
                                </span>
                            </div>
                    `;
                    
                    if (product.recipe) {
                        html += '<div style="font-size: 11px; color: #74b9ff;">éœ€è¦: ';
                        html += Object.keys(product.recipe).map(materialId => {
                            const material = game.getProductByKey(materialId);
                            return `${material ? material.name : materialId} x${product.recipe[materialId]}`;
                        }).join(', ');
                        html += '</div>';
                    } else {
                        html += '<div style="font-size: 11px; color: #00b894;">åŸºç¡€èµ„æº</div>';
                    }
                    
                    html += '</div>';
                });
                
                html += '</div></div>';
            });
            
            content.innerHTML = html;
            modal.style.display = 'flex';
        }
        
        window.onload = () => {
            game = new ComplexManufacturingTycoon();
        };
        
        // é˜²æ­¢æ„å¤–å…³é—­
        window.onbeforeunload = () => {
            if (game && game.companyName && !game.isBankrupt) {
                return 'ç¡®å®šè¦ç¦»å¼€æ¸¸æˆå—ï¼Ÿè¿›åº¦ä¼šè‡ªåŠ¨ä¿å­˜ã€‚';
            }
        };
        
        // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const modal = document.getElementById('dependencyModal');
            if (event.target === modal) {
                closeDependencyModal();
            }
        };
    </script>
</body>
</html>
